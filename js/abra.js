(()=>{"use strict";var __webpack_modules__={926:module=>{var has=Object.prototype.hasOwnProperty,prefix="~";function Events(){}function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function addListener(emitter,event,fn,context,once){if("function"!=typeof fn)throw TypeError("The listener must be a function");var listener=new EE(fn,context||emitter,once),evt=prefix?prefix+event:event;return emitter._events[evt]?emitter._events[evt].fn?emitter._events[evt]=[emitter._events[evt],listener]:emitter._events[evt].push(listener):(emitter._events[evt]=listener,emitter._eventsCount++),emitter}function clearEvent(emitter,evt){0==--emitter._eventsCount?emitter._events=new Events:delete emitter._events[evt]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),new Events().__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function(){var events,name,names=[];if(0===this._eventsCount)return names;for(name in events=this._events)has.call(events,name)&&names.push(prefix?name.slice(1):name);return Object.getOwnPropertySymbols?names.concat(Object.getOwnPropertySymbols(events)):names},EventEmitter.prototype.listeners=function(event){var evt=prefix?prefix+event:event,handlers=this._events[evt];if(!handlers)return[];if(handlers.fn)return[handlers.fn];for(var i=0,l=handlers.length,ee=Array(l);i<l;i++)ee[i]=handlers[i].fn;return ee},EventEmitter.prototype.listenerCount=function(event){var evt=prefix?prefix+event:event,listeners=this._events[evt];return listeners?listeners.fn?1:listeners.length:0},EventEmitter.prototype.emit=function(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return!1;var args,i,listeners=this._events[evt],len=arguments.length;if(listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,void 0,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=Array(len-1);i<len;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;i<length;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,void 0,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=Array(len-1);j<len;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function(event,fn,context){return addListener(this,event,fn,context,!1)},EventEmitter.prototype.once=function(event,fn,context){return addListener(this,event,fn,context,!0)},EventEmitter.prototype.removeListener=function(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn)return clearEvent(this,evt),this;var listeners=this._events[evt];if(listeners.fn)listeners.fn!==fn||once&&!listeners.once||context&&listeners.context!==context||clearEvent(this,evt);else{for(var i=0,events=[],length=listeners.length;i<length;i++)(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context)&&events.push(listeners[i]);events.length?this._events[evt]=1===events.length?events[0]:events:clearEvent(this,evt)}return this},EventEmitter.prototype.removeAllListeners=function(event){var evt;return event?(evt=prefix?prefix+event:event,this._events[evt]&&clearEvent(this,evt)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,module.exports=EventEmitter}},__webpack_module_cache__={};(()=>{function _typeof(o){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o})(o)}function requiredArgs(required,args){if(args.length<required)throw TypeError(required+" argument"+(required>1?"s":"")+" required, but only "+args.length+" present")}function toDate(argument){requiredArgs(1,arguments);var argStr=Object.prototype.toString.call(argument);return argument instanceof Date||"object"===_typeof(argument)&&"[object Date]"===argStr?new Date(argument.getTime()):"number"==typeof argument||"[object Number]"===argStr?new Date(argument):(("string"==typeof argument||"[object String]"===argStr)&&"undefined"!=typeof console&&(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn(Error().stack)),new Date(NaN))}/*! js-cookie v3.0.5 | MIT */function js_cookie_assign(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)target[key]=source[key]}return target}var _PriorityQueue_queue,_PQueue_instances,_PQueue_carryoverConcurrencyCount,_PQueue_isIntervalIgnored,_PQueue_intervalCount,_PQueue_intervalCap,_PQueue_interval,_PQueue_intervalEnd,_PQueue_intervalId,_PQueue_timeoutId,_PQueue_queue,_PQueue_queueClass,_PQueue_pending,_PQueue_concurrency,_PQueue_isPaused,_PQueue_throwOnTimeout,_PQueue_doesIntervalAllowAnother_get,_PQueue_doesConcurrentAllowAnother_get,_PQueue_next,_PQueue_onResumeInterval,_PQueue_isIntervalPaused_get,_PQueue_tryToStartAnother,_PQueue_initializeIntervalIfNeeded,_PQueue_onInterval,_PQueue_processQueue,_PQueue_throwOnAbort,_PQueue_onEvent,LogLevel,range,LogLevel1,morphAttrs,api=function init(converter,defaultAttributes){function set(name,value,attributes){if("undefined"!=typeof document){"number"==typeof(attributes=js_cookie_assign({},defaultAttributes,attributes)).expires&&(attributes.expires=new Date(Date.now()+864e5*attributes.expires)),attributes.expires&&(attributes.expires=attributes.expires.toUTCString()),name=encodeURIComponent(name).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var stringifiedAttributes="";for(var attributeName in attributes)attributes[attributeName]&&(stringifiedAttributes+="; "+attributeName,!0!==attributes[attributeName]&&(stringifiedAttributes+="="+attributes[attributeName].split(";")[0]));return document.cookie=name+"="+converter.write(value,name)+stringifiedAttributes}}return Object.create({set,get:function(name){if("undefined"!=typeof document&&(!arguments.length||name)){for(var cookies=document.cookie?document.cookie.split("; "):[],jar={},i=0;i<cookies.length;i++){var parts=cookies[i].split("="),value=parts.slice(1).join("=");try{var found=decodeURIComponent(parts[0]);if(jar[found]=converter.read(value,found),name===found)break}catch(e){}}return name?jar[name]:jar}},remove:function(name,attributes){set(name,"",js_cookie_assign({},attributes,{expires:-1}))},withAttributes:function(attributes){return init(this.converter,js_cookie_assign({},this.attributes,attributes))},withConverter:function(converter){return init(js_cookie_assign({},this.converter,converter),this.attributes)}},{attributes:{value:Object.freeze(defaultAttributes)},converter:{value:Object.freeze(converter)}})}({read:function(value){return'"'===value[0]&&(value=value.slice(1,-1)),value.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(value){return encodeURIComponent(value).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"}),eventemitter3=function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(void 0!==cachedModule)return cachedModule.exports;var module=__webpack_module_cache__[moduleId]={exports:{}};return __webpack_modules__[moduleId](module,module.exports,__webpack_require__),module.exports}(926);class TimeoutError extends Error{constructor(message){super(message),this.name="TimeoutError"}}class AbortError extends Error{constructor(message){super(),this.name="AbortError",this.message=message}}let getDOMException=errorMessage=>void 0===globalThis.DOMException?new AbortError(errorMessage):new DOMException(errorMessage),getAbortedReason=signal=>{let reason=void 0===signal.reason?getDOMException("This operation was aborted."):signal.reason;return reason instanceof Error?reason:getDOMException(reason)};var __classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};_PriorityQueue_queue=new WeakMap;let priority_queue=class{constructor(){_PriorityQueue_queue.set(this,[])}enqueue(run,options){options={priority:0,...options};let element={priority:options.priority,run};if(this.size&&__classPrivateFieldGet(this,_PriorityQueue_queue,"f")[this.size-1].priority>=options.priority){__classPrivateFieldGet(this,_PriorityQueue_queue,"f").push(element);return}let index=function(array,value,comparator){let first=0,count=array.length;for(;count>0;){let step=Math.trunc(count/2),it=first+step;0>=comparator(array[it],value)?(first=++it,count-=step+1):count=step}return first}(__classPrivateFieldGet(this,_PriorityQueue_queue,"f"),element,(a,b)=>b.priority-a.priority);__classPrivateFieldGet(this,_PriorityQueue_queue,"f").splice(index,0,element)}dequeue(){let item=__classPrivateFieldGet(this,_PriorityQueue_queue,"f").shift();return null==item?void 0:item.run}filter(options){return __classPrivateFieldGet(this,_PriorityQueue_queue,"f").filter(element=>element.priority===options.priority).map(element=>element.run)}get size(){return __classPrivateFieldGet(this,_PriorityQueue_queue,"f").length}};var __classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw TypeError("Private method is not writable");if("a"===kind&&!f)throw TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},dist_classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class dist_AbortError extends Error{}_PQueue_carryoverConcurrencyCount=new WeakMap,_PQueue_isIntervalIgnored=new WeakMap,_PQueue_intervalCount=new WeakMap,_PQueue_intervalCap=new WeakMap,_PQueue_interval=new WeakMap,_PQueue_intervalEnd=new WeakMap,_PQueue_intervalId=new WeakMap,_PQueue_timeoutId=new WeakMap,_PQueue_queue=new WeakMap,_PQueue_queueClass=new WeakMap,_PQueue_pending=new WeakMap,_PQueue_concurrency=new WeakMap,_PQueue_isPaused=new WeakMap,_PQueue_throwOnTimeout=new WeakMap,_PQueue_instances=new WeakSet,_PQueue_doesIntervalAllowAnother_get=function(){return dist_classPrivateFieldGet(this,_PQueue_isIntervalIgnored,"f")||dist_classPrivateFieldGet(this,_PQueue_intervalCount,"f")<dist_classPrivateFieldGet(this,_PQueue_intervalCap,"f")},_PQueue_doesConcurrentAllowAnother_get=function(){return dist_classPrivateFieldGet(this,_PQueue_pending,"f")<dist_classPrivateFieldGet(this,_PQueue_concurrency,"f")},_PQueue_next=function(){var _a;__classPrivateFieldSet(this,_PQueue_pending,(_a=dist_classPrivateFieldGet(this,_PQueue_pending,"f"),--_a),"f"),dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_tryToStartAnother).call(this),this.emit("next")},_PQueue_onResumeInterval=function(){dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_onInterval).call(this),dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_initializeIntervalIfNeeded).call(this),__classPrivateFieldSet(this,_PQueue_timeoutId,void 0,"f")},_PQueue_isIntervalPaused_get=function(){let now=Date.now();if(void 0===dist_classPrivateFieldGet(this,_PQueue_intervalId,"f")){let delay=dist_classPrivateFieldGet(this,_PQueue_intervalEnd,"f")-now;if(!(delay<0))return void 0===dist_classPrivateFieldGet(this,_PQueue_timeoutId,"f")&&__classPrivateFieldSet(this,_PQueue_timeoutId,setTimeout(()=>{dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_onResumeInterval).call(this)},delay),"f"),!0;__classPrivateFieldSet(this,_PQueue_intervalCount,dist_classPrivateFieldGet(this,_PQueue_carryoverConcurrencyCount,"f")?dist_classPrivateFieldGet(this,_PQueue_pending,"f"):0,"f")}return!1},_PQueue_tryToStartAnother=function(){if(0===dist_classPrivateFieldGet(this,_PQueue_queue,"f").size)return dist_classPrivateFieldGet(this,_PQueue_intervalId,"f")&&clearInterval(dist_classPrivateFieldGet(this,_PQueue_intervalId,"f")),__classPrivateFieldSet(this,_PQueue_intervalId,void 0,"f"),this.emit("empty"),0===dist_classPrivateFieldGet(this,_PQueue_pending,"f")&&this.emit("idle"),!1;if(!dist_classPrivateFieldGet(this,_PQueue_isPaused,"f")){let canInitializeInterval=!dist_classPrivateFieldGet(this,_PQueue_instances,"a",_PQueue_isIntervalPaused_get);if(dist_classPrivateFieldGet(this,_PQueue_instances,"a",_PQueue_doesIntervalAllowAnother_get)&&dist_classPrivateFieldGet(this,_PQueue_instances,"a",_PQueue_doesConcurrentAllowAnother_get)){let job=dist_classPrivateFieldGet(this,_PQueue_queue,"f").dequeue();return!!job&&(this.emit("active"),job(),canInitializeInterval&&dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_initializeIntervalIfNeeded).call(this),!0)}}return!1},_PQueue_initializeIntervalIfNeeded=function(){dist_classPrivateFieldGet(this,_PQueue_isIntervalIgnored,"f")||void 0!==dist_classPrivateFieldGet(this,_PQueue_intervalId,"f")||(__classPrivateFieldSet(this,_PQueue_intervalId,setInterval(()=>{dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_onInterval).call(this)},dist_classPrivateFieldGet(this,_PQueue_interval,"f")),"f"),__classPrivateFieldSet(this,_PQueue_intervalEnd,Date.now()+dist_classPrivateFieldGet(this,_PQueue_interval,"f"),"f"))},_PQueue_onInterval=function(){0===dist_classPrivateFieldGet(this,_PQueue_intervalCount,"f")&&0===dist_classPrivateFieldGet(this,_PQueue_pending,"f")&&dist_classPrivateFieldGet(this,_PQueue_intervalId,"f")&&(clearInterval(dist_classPrivateFieldGet(this,_PQueue_intervalId,"f")),__classPrivateFieldSet(this,_PQueue_intervalId,void 0,"f")),__classPrivateFieldSet(this,_PQueue_intervalCount,dist_classPrivateFieldGet(this,_PQueue_carryoverConcurrencyCount,"f")?dist_classPrivateFieldGet(this,_PQueue_pending,"f"):0,"f"),dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_processQueue).call(this)},_PQueue_processQueue=function(){for(;dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_tryToStartAnother).call(this););},_PQueue_throwOnAbort=async function(signal){return new Promise((_resolve,reject)=>{signal.addEventListener("abort",()=>{reject(new dist_AbortError("The task was aborted."))},{once:!0})})},_PQueue_onEvent=async function(event,filter){return new Promise(resolve=>{let listener=()=>{(!filter||filter())&&(this.off(event,listener),resolve())};this.on(event,listener)})};let dist=class extends eventemitter3{constructor(options){var _a,_b,_c,_d;if(super(),_PQueue_instances.add(this),_PQueue_carryoverConcurrencyCount.set(this,void 0),_PQueue_isIntervalIgnored.set(this,void 0),_PQueue_intervalCount.set(this,0),_PQueue_intervalCap.set(this,void 0),_PQueue_interval.set(this,void 0),_PQueue_intervalEnd.set(this,0),_PQueue_intervalId.set(this,void 0),_PQueue_timeoutId.set(this,void 0),_PQueue_queue.set(this,void 0),_PQueue_queueClass.set(this,void 0),_PQueue_pending.set(this,0),_PQueue_concurrency.set(this,void 0),_PQueue_isPaused.set(this,void 0),_PQueue_throwOnTimeout.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!("number"==typeof(options={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:priority_queue,...options}).intervalCap&&options.intervalCap>=1))throw TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(_b=null===(_a=options.intervalCap)||void 0===_a?void 0:_a.toString())&&void 0!==_b?_b:""}\` (${typeof options.intervalCap})`);if(void 0===options.interval||!(Number.isFinite(options.interval)&&options.interval>=0))throw TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(_d=null===(_c=options.interval)||void 0===_c?void 0:_c.toString())&&void 0!==_d?_d:""}\` (${typeof options.interval})`);__classPrivateFieldSet(this,_PQueue_carryoverConcurrencyCount,options.carryoverConcurrencyCount,"f"),__classPrivateFieldSet(this,_PQueue_isIntervalIgnored,options.intervalCap===Number.POSITIVE_INFINITY||0===options.interval,"f"),__classPrivateFieldSet(this,_PQueue_intervalCap,options.intervalCap,"f"),__classPrivateFieldSet(this,_PQueue_interval,options.interval,"f"),__classPrivateFieldSet(this,_PQueue_queue,new options.queueClass,"f"),__classPrivateFieldSet(this,_PQueue_queueClass,options.queueClass,"f"),this.concurrency=options.concurrency,this.timeout=options.timeout,__classPrivateFieldSet(this,_PQueue_throwOnTimeout,!0===options.throwOnTimeout,"f"),__classPrivateFieldSet(this,_PQueue_isPaused,!1===options.autoStart,"f")}get concurrency(){return dist_classPrivateFieldGet(this,_PQueue_concurrency,"f")}set concurrency(newConcurrency){if(!("number"==typeof newConcurrency&&newConcurrency>=1))throw TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${newConcurrency}\` (${typeof newConcurrency})`);__classPrivateFieldSet(this,_PQueue_concurrency,newConcurrency,"f"),dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_processQueue).call(this)}async add(function_,options={}){return options={timeout:this.timeout,throwOnTimeout:dist_classPrivateFieldGet(this,_PQueue_throwOnTimeout,"f"),...options},new Promise((resolve,reject)=>{dist_classPrivateFieldGet(this,_PQueue_queue,"f").enqueue(async()=>{var _a,_b,_c;__classPrivateFieldSet(this,_PQueue_pending,(_b=dist_classPrivateFieldGet(this,_PQueue_pending,"f"),++_b),"f"),__classPrivateFieldSet(this,_PQueue_intervalCount,(_c=dist_classPrivateFieldGet(this,_PQueue_intervalCount,"f"),++_c),"f");try{if(null===(_a=options.signal)||void 0===_a?void 0:_a.aborted)throw new dist_AbortError("The task was aborted.");let operation=function_({signal:options.signal});options.timeout&&(operation=function(promise,milliseconds,fallback,options){let timer;let cancelablePromise=new Promise((resolve,reject)=>{if("number"!=typeof milliseconds||1!==Math.sign(milliseconds))throw TypeError(`Expected \`milliseconds\` to be a positive number, got \`${milliseconds}\``);if(milliseconds===Number.POSITIVE_INFINITY){resolve(promise);return}if((options={customTimers:{setTimeout,clearTimeout},...options}).signal){let{signal}=options;signal.aborted&&reject(getAbortedReason(signal)),signal.addEventListener("abort",()=>{reject(getAbortedReason(signal))})}timer=options.customTimers.setTimeout.call(void 0,()=>{if("function"==typeof fallback){try{resolve(fallback())}catch(error){reject(error)}return}let message="string"==typeof fallback?fallback:`Promise timed out after ${milliseconds} milliseconds`,timeoutError=fallback instanceof Error?fallback:new TimeoutError(message);"function"==typeof promise.cancel&&promise.cancel(),reject(timeoutError)},milliseconds),(async()=>{try{resolve(await promise)}catch(error){reject(error)}finally{options.customTimers.clearTimeout.call(void 0,timer)}})()});return cancelablePromise.clear=()=>{clearTimeout(timer),timer=void 0},cancelablePromise}(Promise.resolve(operation),options.timeout)),options.signal&&(operation=Promise.race([operation,dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_throwOnAbort).call(this,options.signal)]));let result=await operation;resolve(result),this.emit("completed",result)}catch(error){if(error instanceof TimeoutError&&!options.throwOnTimeout){resolve();return}reject(error),this.emit("error",error)}finally{dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_next).call(this)}},options),this.emit("add"),dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_tryToStartAnother).call(this)})}async addAll(functions,options){return Promise.all(functions.map(async function_=>this.add(function_,options)))}start(){return dist_classPrivateFieldGet(this,_PQueue_isPaused,"f")&&(__classPrivateFieldSet(this,_PQueue_isPaused,!1,"f"),dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_processQueue).call(this)),this}pause(){__classPrivateFieldSet(this,_PQueue_isPaused,!0,"f")}clear(){__classPrivateFieldSet(this,_PQueue_queue,new(dist_classPrivateFieldGet(this,_PQueue_queueClass,"f")),"f")}async onEmpty(){0!==dist_classPrivateFieldGet(this,_PQueue_queue,"f").size&&await dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_onEvent).call(this,"empty")}async onSizeLessThan(limit){dist_classPrivateFieldGet(this,_PQueue_queue,"f").size<limit||await dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_onEvent).call(this,"next",()=>dist_classPrivateFieldGet(this,_PQueue_queue,"f").size<limit)}async onIdle(){(0!==dist_classPrivateFieldGet(this,_PQueue_pending,"f")||0!==dist_classPrivateFieldGet(this,_PQueue_queue,"f").size)&&await dist_classPrivateFieldGet(this,_PQueue_instances,"m",_PQueue_onEvent).call(this,"idle")}get size(){return dist_classPrivateFieldGet(this,_PQueue_queue,"f").size}sizeBy(options){return dist_classPrivateFieldGet(this,_PQueue_queue,"f").filter(options).length}get pending(){return dist_classPrivateFieldGet(this,_PQueue_pending,"f")}get isPaused(){return dist_classPrivateFieldGet(this,_PQueue_isPaused,"f")}};function storage_isLocalStorageSupported(){return void 0!==window.localStorage}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){reject(error);return}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}(LogLevel1=LogLevel||(LogLevel={}))[LogLevel1.Debug=0]="Debug",LogLevel1[LogLevel1.Log=1]="Log",LogLevel1[LogLevel1.Info=2]="Info",LogLevel1[LogLevel1.Warn=3]="Warn",LogLevel1[LogLevel1.Error=4]="Error",LogLevel1[LogLevel1.Alert=5]="Alert";var BrowserLogger=function(){function BrowserLogger(context,options){void 0===options&&(options={}),this.context=context,this.url=new URL(options.url||window.location.href),this.logContext=this.getLogContext(),this.logLevel=this.getLogLevel(),this.options=options}var _proto=BrowserLogger.prototype;return _proto.createSubLogger=function(context){return new BrowserLogger(this.context+"/"+context,this.options)},_proto.debug=function(){for(var _console,_len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.logLevel>0||this.logContext&&this.logContext!==this.context||(_console=console).debug.apply(_console,[].concat(["["+this.context+"]"],args))},_proto.log=function(){for(var _console,_len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.logLevel>1||this.logContext&&this.logContext!==this.context||(_console=console).log.apply(_console,[].concat(["["+this.context+"]"],args))},_proto.info=function(){for(var _console,_len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.logLevel>2||this.logContext&&this.logContext!==this.context||(_console=console).info.apply(_console,[].concat(["["+this.context+"]"],args))},_proto.warn=function(){for(var _console,_len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.logLevel>3||this.logContext&&this.logContext!==this.context||(_console=console).warn.apply(_console,[].concat(["["+this.context+"]"],args))},_proto.error=function(){for(var _console,_len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.logLevel>4||this.logContext&&this.logContext!==this.context||(_console=console).error.apply(_console,[].concat(["["+this.context+"]"],args))},_proto.alert=function(userMessage,errorClass){for(var fn,_len=arguments.length,args=Array(_len>2?_len-2:0),_key=2;_key<_len;_key++)args[_key-2]=arguments[_key];var _this=this;return(fn=function(){var _this_options_alert_excludedHosts,_this_options_alert,_this_options_alert1,_console;return function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}(this,function(_state){switch(_state.label){case 0:if(_this.logLevel>5||_this.logContext&&_this.logContext!==_this.context||(null==(_this_options_alert=_this.options.alert)?void 0:null==(_this_options_alert_excludedHosts=_this_options_alert.excludedHosts)?void 0:_this_options_alert_excludedHosts.includes(_this.url.host)))return[2];if(!(null==(_this_options_alert1=_this.options.alert)?void 0:_this_options_alert1.endpoint))return[3,5];(_console=console).error.apply(_console,[].concat(["["+_this.context+"]",userMessage,errorClass],args)),_state.label=1;case 1:return _state.trys.push([1,3,,4]),[4,fetch(_this.options.alert.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cause:null==errorClass?void 0:errorClass.cause,message:null==errorClass?void 0:errorClass.message,name:null==errorClass?void 0:errorClass.name,stack:null==errorClass?void 0:errorClass.stack,userAgent:navigator.userAgent,userMessage:userMessage})})];case 2:return _state.sent(),[3,4];case 3:return console.error("failed to alert app developer",{err:_state.sent()}),[3,4];case 4:return[3,6];case 5:console.error('you must set an alert endpoint, i.e. { alertEndpoint: "/alert" }'),_state.label=6;case 6:return[2]}})},function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)})})()},_proto.getLogLevel=function(){var logLevelParam=this.url.searchParams.get("_log");return storage_isLocalStorageSupported()&&(logLevelParam||(logLevelParam=window.localStorage.getItem("_log")),logLevelParam&&window.localStorage.setItem("_log",logLevelParam)),logLevelParam?parseInt(logLevelParam,10):2},_proto.getLogContext=function(){var logContext=this.url.searchParams.get("_logc");return storage_isLocalStorageSupported()&&(logContext||(logContext=window.localStorage.getItem("_logc")),logContext&&window.localStorage.setItem("_logc",logContext)),logContext||void 0},BrowserLogger}();let logger=new BrowserLogger("abra",{alert:{endpoint:"/apps/abra/alert?_abraignore=1",excludedHosts:["shopwigdealer.com","abra-development-1.myshopify.com"]}});class NetworkObserver{#e;#r;constructor(r,{ignoreRegex:s,includeRegex:t}){this.#e=logger.createSubLogger("network"),this.#r=void 0,this.ignoreRegex=s,this.includeRegex=t,this.isUnsupported=void 0===window.PerformanceObserver,this.onRequest=r,this.callback=this.callback.bind(this)}observe(){if(this.isUnsupported){this.#e.warn("PerformanceObserver isn't supported by this browser. Features may be affected");return}return this.#r&&this.disconnect(),this.#r=new PerformanceObserver(this.callback),this.#r.observe({entryTypes:["resource"]})}disconnect(){this.#r&&(this.#r.disconnect(),this.#r=void 0)}callback(e){let r=!1;for(let s of e.getEntries())if(!this.ignoreRegex.test(s.name)&&this.includeRegex.test(s.name)){this.#e.debug("detected request that changes DOM",s.name),r=!0;break}r&&window.requestAnimationFrame(()=>this.onRequest())}}function addListener(e,t){if(e){if("string"==typeof e)window.addEventListener(e,t),document.addEventListener(e,t);else if("object"==typeof e){let n=Object.values(e);n.forEach(e=>{window.addEventListener(e,t),document.addEventListener(e,t)})}else throw TypeError("onevent must be a string or an object")}}function removeListener(e,t){if(e){if("string"==typeof e)window.removeEventListener(e,t),document.removeEventListener(e,t);else if("object"==typeof e){let n=Object.values(e);n.forEach(e=>{window.addEventListener(e,t),document.addEventListener(e,t)})}else throw TypeError("onevent must be a string or an object")}}class AddClassBlock{static #t=this.validate=t=>{let e=[];return(t.selector||e.push("'selector' is required"),t.value||e.push("'value' is required"),e.length>0)?{errors:e,config:t}:{errors:!1,config:t}};#e;constructor(e,i){this.#e=logger.createSubLogger(`blocks/add-class/${e}`),this.applied=!1,this.config=i,this.elements=[],this.id=e,this.type=i.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}apply(){for(let t of(this.#e.debug("applying",{id:this.id,config:this.config}),this.config.onevent&&addListener(this.config.onevent,this.apply),this.#i(),this.elements))t.setAttribute("data-abra-selector",this.config.selector),t.setAttribute("data-abra-block",this.config.type),t.classList.add(this.config.value);return this.applied=!0,!0}undo(){for(let t of(this.#e.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),this.elements))t.removeAttribute("data-abra-selector"),t.removeAttribute("data-abra-block"),t.classList.remove(this.config.value);return this.elements=[],this.applied=!1,!0}#i(){return this.elements=Array.from(document.querySelectorAll(this.config.selector)),this}}function setDiscountInCartForm(t){if(!t)return;let e=document.querySelectorAll('form[action="/cart"]'),i=document.createElement("input");i.type="hidden",i.name="discount",i.value=t,e.forEach(t1=>{let e=t1.querySelector('input[name="discount"]');e?e.value=t:t1.appendChild(i)})}function findGiftInCart(t,n,e){let i=t.items.find(t=>t.discounts.some(t=>t.title===n));return i||t.items.find(t=>isCartItemGift(t,n,e))}function isCartItemGift(t,n,e){return t.variantId==e&&t.getAbraProperty()?.offer===n}let n=logger.createSubLogger("money");function parseDecimalMoney(e){if("number"==typeof e)return e;let r=e.replaceAll(",","").split(".");if(!r[0]||!r[1]){n.debug("decimal couldn't be parsed",{decimal:e,parts:r});return}let t=r[0],o=r[1].length;return parseInt(t,10)*Math.pow(10,o)+parseInt(r[1],10)}function getShopCurrency(){return void 0!==window.Shopify&&window.Shopify?.currency?.active||window.Abra.currency}function convertToStorefrontCurrency(e){let r=getShopCurrency();if(r!==e.currencyCode){let n=window.Shopify?.currency?.rate?parseFloat(window.Shopify?.currency?.rate):1;return{cents:e.cents*n,amount:(parseFloat(e.amount)*n).toString(),currencyCode:r}}return{cents:e.cents,amount:e.amount,currencyCode:e.currencyCode}}function convertOfferToStorefrontCurrency(e){return e.discountValue?.type==="DiscountAmount"&&e.discountValue.discountAmount&&(e.discountValue.discountAmount=convertToStorefrontCurrency(e.discountValue.discountAmount)),e.prerequisite?.minimumRequirement?.greaterThanOrEqualToSubtotal&&(e.prerequisite.minimumRequirement.greaterThanOrEqualToSubtotal=convertToStorefrontCurrency(e.prerequisite.minimumRequirement.greaterThanOrEqualToSubtotal)),e}function money_formatMoney(r,n){return(void 0===n&&(n={}),"string"==typeof r||"number"==typeof r)?n.outputZero||0!=r?function(cents,format){"string"==typeof cents&&(cents=cents.replace(".",""));let value="",placeholderRegex=/\{\{\s*(\w+)\s*\}\}/,formatString=format||"${{amount}}";function formatWithDelimiters(number,precision=2,thousands=",",decimal="."){if(isNaN(number)||null==number)return 0;number=(number/100).toFixed(precision);let parts=number.split("."),dollarsAmount=parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g,`$1${thousands}`),centsAmount=parts[1]?decimal+parts[1]:"";return dollarsAmount+centsAmount}switch(formatString.match(placeholderRegex)[1]){case"amount":value=formatWithDelimiters(cents,2);break;case"amount_no_decimals":value=formatWithDelimiters(cents,0);break;case"amount_with_comma_separator":value=formatWithDelimiters(cents,2,".",",");break;case"amount_no_decimals_with_comma_separator":value=formatWithDelimiters(cents,0,".",",")}return formatString.replace(placeholderRegex,value)}(r,window.Abra.moneyFormat):window.Abra.settings?.translations?.free_price??"Free":""}function findCollectionHandle(){let o=function(n){void 0===n&&(n=window.location.href);let o=n.split("/"),t=o.indexOf("collections");if(-1===t)return;let i=o.indexOf("collections")+1,c=o[i].split("?")[0];return c}();return o}function safeParseInt(r){return"string"==typeof r?parseInt(r,10):r}function isPrerequisiteValid(e,r,i){if(e?.minimumRequirement?.greaterThanOrEqualToQuantity&&r<safeParseInt(e.minimumRequirement.greaterThanOrEqualToQuantity))return!1;if(e?.minimumRequirement?.greaterThanOrEqualToSubtotal){let r=convertToStorefrontCurrency(e.minimumRequirement.greaterThanOrEqualToSubtotal);if(i<r.cents)return!1}return!0}function getPrerequisiteState(e,i,u){if(e?.minimumRequirement?.greaterThanOrEqualToQuantity){let t=safeParseInt(e.minimumRequirement.greaterThanOrEqualToQuantity),r=t.toString();return 0===i?{state:"PROGRESS_ZERO",progress:{percentage:"0",remainder:t.toString(),total:r}}:i<t?{state:"PROGRESS_OTHER",progress:{percentage:Math.floor(i/t*100).toString(),remainder:(t-i).toString(),total:r}}:{state:"SUCCESS",progress:{percentage:"100",remainder:"0",total:r}}}if(e?.minimumRequirement?.greaterThanOrEqualToSubtotal){let n=convertToStorefrontCurrency(e.minimumRequirement.greaterThanOrEqualToSubtotal),i=money_formatMoney(n.cents,{outputZero:!0});if(0===u)return{state:"PROGRESS_ZERO",progress:{percentage:"0",remainder:money_formatMoney(n.cents,{outputZero:!0}),total:i}};if(!(u<n.cents))return{state:"SUCCESS",progress:{percentage:"100",remainder:money_formatMoney(0,{outputZero:!0}),total:i}};{let e=n.cents-u;return{state:"PROGRESS_OTHER",progress:{percentage:Math.floor(u/n.cents*100).toString(),remainder:money_formatMoney(e,{outputZero:!0}),total:i}}}}return{state:"SUCCESS",progress:void 0}}function isProductEntitledToOffer(t,r,n){if(t.entitled?.all||t.entitled?.variants&&n&&t.entitled.variants.includes(n.toString())||t.entitled?.products&&r&&t.entitled.products.includes(r))return!0;let i=findCollectionHandle();return!!(t.entitled?.collections&&i&&t.entitled.collections.includes(i))}class GiftOffer{static #t=this.MAX_ATTEMPTS=3;#i;#e;#s;constructor(i){i=convertOfferToStorefrontCurrency(i),this.#s=logger.createSubLogger("gift-offer"),this.#i=0,this.#e=0,this.appliesOnOneTimePurchase=i.appliesOnOneTimePurchase,this.appliesOnSubscription=i.appliesOnSubscription,this.discountClass=i.discountClass,this.discountValue=i.discountValue,this.entitled=i.entitled,this.endsAt=i.endsAt,this.id=i.id,this.prerequisite=i.prerequisite,this.startsAt=i.startsAt,this.status=i.status,this.title=i.title}async applyToCart(t){if(this.discountValue?.type!=="Gift")return t;this.#s.debug("offering free gifts",{gifts:this.discountValue.products,cart:t});for(let e=0;e<this.discountValue.products.length;e++){let s=this.discountValue.products[e];if(s){await new Promise(t=>setTimeout(t,800));for(let e=0;e<s.variants.length;e++){let r=s?.variants[e]?.id;if(!r){this.#s.error("offer is missing a gift");continue}let n=findGiftInCart(t,this.title,r);if(n&&this.isCartEligible(t))n.discount(n.price.final),t.codes.add(this.title),n.codes.add(this.title);else if(!n&&this.isCartEligible(t)){if(this.#i>GiftOffer.MAX_ATTEMPTS){this.#s.warn("attempted to add gift too many times, refresh and try again");continue}this.#i++;try{let i=await t.addItem({variant:r,quantity:1,properties:{offer:this.title,hideQuantity:!0}});if(!i||!i?.variant_id)break}catch(t){window.Abra.Notification.show({content:"Error: Your free gift isn't available"}),this.#s.error(t);continue}await new Promise(t=>setTimeout(t,500)),this.#i=0,window.dispatchEvent(new CustomEvent("abra:cart:changed"));let e=findGiftInCart(t,this.title,r);e?.discount(e.price.final),e?.codes.add(this.title),t.codes.add(this.title)}}}}return t}async unapplyFromCart(t){if(this.discountValue?.type!=="Gift"||this.isCartEligible(t))return t;for(let e=0;e<this.discountValue.products.length;e++){let s=this.discountValue.products[e];if(s)for(let e=0;e<s.variants.length;e++){let r=s?.variants[e]?.id;if(!r){this.#s.error("offer is missing a gift");continue}let n=findGiftInCart(t,this.title,r);if(n){if(this.#e>GiftOffer.MAX_ATTEMPTS){this.#s.warn("attempted to remove gift too many times, refresh and try again");continue}this.#e++;try{await t.removeItemByKey(n.key)}catch(t){this.#s.error(t);continue}this.#e=0,window.dispatchEvent(new CustomEvent("abra:cart:changed"))}}}return t}async applyToPrice(t){return t}async applyToProduct(t,i){return t}getCartEligibility(t){let{entitledQuantity:i,entitledTotal:e}=this.#r(t),{state:s,progress:n}=getPrerequisiteState(this.prerequisite,i,e);return{state:s,progress:n}}isCartEntitled(t){return t.items.some(t=>this.isCartItemEntitled(t))}isCartEligible(t){let{entitledItems:i,entitledQuantity:e,entitledTotal:s}=this.#r(t);return!!(i.length&&isPrerequisiteValid(this.prerequisite,e,s))}isCartItemEntitled(t){return!!(this.entitled?.all||this.entitled?.variants&&this.entitled.variants.includes(t.variantId.toString())||this.entitled?.products&&this.entitled.products.includes(t.handle))&&(this.appliesOnSubscription&&!this.appliesOnOneTimePurchase?t.isSellingPlan():!!this.appliesOnSubscription||!this.appliesOnOneTimePurchase||t.isOneTimePurchase())}isCollectionEntitled(t){return!!(this.entitled?.all||this.entitled?.collections&&this.entitled.collections.includes(t))}isProductEntitled(t,i){let e=isProductEntitledToOffer(this,t,i);return e}isShownInCart(){return!0}isShownInCartItem(){return!0}isShownInCollection(t){return"product"!==t}isShownInProduct(t){return"product"!==t}#r(t){let i=t.items.filter(t=>this.isCartItemEntitled(t)),{entitledQuantity:s,entitledTotal:r}=i.reduce((t,i)=>(isCartItemGift(i,this.title,i.variantId)||(t.entitledQuantity+=i.quantity,t.entitledTotal+=i.linePrice.original),t),{entitledQuantity:0,entitledTotal:0});return{entitledQuantity:s,entitledTotal:r,entitledItems:i}}}class OrderOffer{#t;constructor(e){e=convertOfferToStorefrontCurrency(e),this.#t=logger.createSubLogger("order-offer"),this.appliesOnOneTimePurchase=e.appliesOnOneTimePurchase,this.appliesOnSubscription=e.appliesOnSubscription,this.discountClass=e.discountClass,this.discountValue=e.discountValue,this.entitled=e.entitled,this.endsAt=e.endsAt,this.id=e.id,this.prerequisite=e.prerequisite,this.startsAt=e.startsAt,this.status=e.status,this.title=e.title}async applyToCart(t){if(t.codes.has(this.title))return t;let i=t.items.filter(t=>this.isCartItemEntitled(t)),e=i.reduce((t,i)=>t+i.linePrice.original,0);for(let s=0;s<i.length;s++){let n=i[s];if(this.discountValue?.type==="DiscountAmount"&&s===i.length-1){let i=t.subtotalPrice.originalTotalDiscount,e=this.discountValue.discountAmount.cents-i;n.discount(e);continue}let r=n.linePrice.original/e,u=0;this.discountValue?.type==="DiscountAmount"?u=Math.round(this.discountValue.discountAmount.cents*r):this.discountValue?.type==="DiscountPercentage"&&(u=Math.round(e*this.discountValue.percentage*r)),n.discount(u)}return t.codes.add(this.title),t}async unapplyFromCart(t){return t}async applyToPrice(t){return this.discountValue?.type==="DiscountAmount"?t.discount(this.discountValue.discountAmount.cents):this.discountValue?.type==="DiscountPercentage"&&t.discount(Math.round(t.original*this.discountValue.percentage)),t}async applyToProduct(t,i){if(this.discountValue?.type==="DiscountAmount")t.discount(this.discountValue.discountAmount.cents,i);else if(this.discountValue?.type==="DiscountPercentage"){let e=t.getPrice(i)?.original??0;t.discount(Math.round(e*this.discountValue.percentage),i)}return t}getCartEligibility(t){let{itemCount:i,subtotalPrice:s}=t,{state:n,progress:r}=getPrerequisiteState(this.prerequisite,i,s.original);return"SUCCESS"!==n&&this.#t.debug("cart isn't eligible",{itemCount:i,subtotalPrice:s.original,prerequisite:this.prerequisite}),{state:n,progress:r}}isCartEntitled(t){return t.items.some(t=>this.isCartItemEntitled(t))}isCartEligible(t){let{itemCount:i,subtotalPrice:e}=t,n=isPrerequisiteValid(this.prerequisite,i,e.original);return n||this.#t.debug("cart isn't eligible",{itemCount:i,subtotalPrice:e.original,prerequisite:this.prerequisite}),this.isCartEntitled(t)&&n}isCartItemEntitled(t){return!t.isGiftCard&&(this.appliesOnSubscription&&!this.appliesOnOneTimePurchase?t.isSellingPlan():!!this.appliesOnSubscription||!this.appliesOnOneTimePurchase||t.isOneTimePurchase())}isCollectionEntitled(t){return!!(this.entitled?.all||this.entitled?.collections&&this.entitled.collections.includes(t))}isProductEntitled(t,i){let e=isProductEntitledToOffer(this,t,i);return e}isShownInCart(){return!0}isShownInCartItem(){return!1}isShownInCollection(){return!1}isShownInProduct(t){return"cart"!==t&&"cart-item"!==t&&"product"!==t}}class ProductOffer{#t;constructor(e){e=convertOfferToStorefrontCurrency(e),this.#t=logger.createSubLogger("product-offer"),this.appliesOnOneTimePurchase=e.appliesOnOneTimePurchase,this.appliesOnSubscription=e.appliesOnSubscription,this.discountClass=e.discountClass,this.discountValue=e.discountValue,this.entitled=e.entitled,this.endsAt=e.endsAt,this.id=e.id,this.prerequisite=e.prerequisite,this.startsAt=e.startsAt,this.status=e.status,this.title=e.title}async applyToCart(t){let i=t.items.filter(t=>this.isCartItemEntitled(t)&&!t.codes.has(this.title));if(this.discountValue?.type!=="DiscountAmount"||this.discountValue.appliesOnEachItem)for(let t=0;t<i.length;t++){let e=i[t];if(this.discountValue?.type==="DiscountAmount"){let t=this.discountValue.discountAmount.cents*e.quantity;e.discount(Math.floor(t)),e.codes.add(this.title)}else if(this.discountValue?.type==="DiscountPercentage"){let t=e.linePrice.original*this.discountValue.percentage;e.discount(Math.floor(t)),e.codes.add(this.title)}}else{let e=i.reduce((t,i)=>t+=i.linePrice.original,0);for(let s=0;s<i.length;s++){let n=i[s];if(s===i.length-1){let i=t.subtotalPrice.originalTotalDiscount,e=this.discountValue.discountAmount.cents-i;n.discount(e),n.codes.add(this.title);continue}let r=n.linePrice.original/e,l=this.discountValue.discountAmount.cents*r;n.discount(Math.ceil(l)),n.codes.add(this.title)}}return t}async unapplyFromCart(t){return t}async applyToPrice(t){return this.discountValue?.type==="DiscountAmount"?t.discount(this.discountValue.discountAmount.cents):this.discountValue?.type==="DiscountPercentage"&&t.discount(Math.floor(t.original*this.discountValue.percentage)),t}async applyToProduct(t,i){if(!this.isProductEntitled(t.handle,i))return t;if(this.discountValue?.type==="DiscountAmount")t.discount(this.discountValue.discountAmount.cents,i);else if(this.discountValue?.type==="DiscountPercentage"){let e=t.getPrice(i)?.original??0;t.discount(Math.floor(e*this.discountValue.percentage),i)}return t}getCartEligibility(t){let i=t.items.filter(t=>this.isCartItemEntitled(t)),{entitledQuantity:s,entitledTotal:n}=i.reduce((t,i)=>(t.entitledQuantity+=i.quantity,t.entitledTotal+=i.linePrice.original,t),{entitledQuantity:0,entitledTotal:0}),{state:r,progress:l}=getPrerequisiteState(this.prerequisite,s,n);return{state:r,progress:l}}isCartEntitled(t){return t.items.some(t=>this.isCartItemEntitled(t))}isCartEligible(t){let i=t.items.filter(t=>this.isCartItemEntitled(t)),{entitledQuantity:e,entitledTotal:n}=i.reduce((t,i)=>(t.entitledQuantity+=i.quantity,t.entitledTotal+=i.linePrice.original,t),{entitledQuantity:0,entitledTotal:0});return this.isCartEntitled(t)&&isPrerequisiteValid(this.prerequisite,e,n)}isCartItemEntitled(t){return!!(this.entitled?.all||this.entitled?.variants&&this.entitled.variants.includes(t.variantId.toString())||this.entitled?.products&&this.entitled.products.includes(t.handle))&&(this.appliesOnSubscription&&!this.appliesOnOneTimePurchase?t.isSellingPlan():!!this.appliesOnSubscription||!this.appliesOnOneTimePurchase||t.isOneTimePurchase())}isCollectionEntitled(t){return!!(this.entitled?.all||this.entitled?.collections&&this.entitled.collections.includes(t))}isProductEntitled(t,i){let e=isProductEntitledToOffer(this,t,i);return e}isShownInCart(){return!1}isShownInCartItem(){return!0}isShownInCollection(){return!0}isShownInProduct(){return!0}}class MultiValueOffer{constructor(i){i=convertOfferToStorefrontCurrency(i),this.appliesOnOneTimePurchase=i.appliesOnOneTimePurchase,this.appliesOnSubscription=i.appliesOnSubscription,this.discountClass=i.discountClass,this.discountValue=i.discountValue,this.startsAt=i.startsAt,this.endsAt=i.endsAt,this.id=i.id,this.status=i.status,this.title=i.title,this.entitled=i.entitled}async applyToCart(t){let i=t.items.filter(t=>this.isCartItemEntitled(t));for(let t=0;t<i.length;t++){let e=i[t],s=e.linePrice.original,n=this.#t(s,e.handle,e.variantId);e.discount(n),e.codes.add(this.title)}return t}async unapplyFromCart(t){return t}async applyToPrice(t,i,e){if(!this.isProductEntitled(i,e))return t;let s=t.original,n=this.#t(s,i,e);return t.discount(n),t}async applyToProduct(t,i){if(!this.isProductEntitled(t.handle,i))return t;let e=t.getPrice(i)?.original??0,s=this.#t(e,t.handle,i);return t.discount(s,i),t}getCartEligibility(){return!1}isCartEligible(t){return t.items.some(t=>this.isCartItemEntitled(t))}isCartEntitled(t){return t.items.some(t=>this.isCartItemEntitled(t))}isCartItemEntitled(t){let i=this.#i();if(i&&i.includes(t.variantId.toString()))return this.appliesOnSubscription&&!this.appliesOnOneTimePurchase?t.isSellingPlan():!!this.appliesOnSubscription||!this.appliesOnOneTimePurchase||t.isOneTimePurchase();let e=this.#e();return!!(e&&e.includes(t.handle))&&(this.appliesOnSubscription&&!this.appliesOnOneTimePurchase?t.isSellingPlan():!!this.appliesOnSubscription||!this.appliesOnOneTimePurchase||t.isOneTimePurchase())}isCollectionEntitled(t){let i=this.discountValue?.collections;return i?.includes(t)??!1}isProductEntitled(t,i){let e=this.#e(),s=this.#i();return!!(s&&i&&s.includes(i)||e&&e.includes(t))}isShownInCart(){return!1}isShownInCartItem(){return!0}isShownInCollection(){return!0}isShownInProduct(){return!0}#i(){return this.discountValue?.variantDiscounts?.map(t=>t.variants).flat()}#e(){return this?.discountValue?.productDiscounts?.map(t=>t.products).flat()}#t(t,i,e){let s=this.discountValue?.productDiscounts.filter(t=>t.products.includes(i))??[],n=[];e&&(n=this.discountValue?.variantDiscounts.filter(t=>t.variants.includes(e.toString()))??[]);let r=[...s,...n];return r.reduce((i,e)=>{let s=0;return"DiscountAmount"===e.value.type?s=e.value.discountAmount.cents:"DiscountPercentage"===e.value.type&&(s=Math.floor(t*(e.value.percentage/100))),Math.max(i,s)},0)}}class Promotion{#t;get displayCode(){return this.redeemCode||this.code}constructor(t){this.#t=t,this.code=t.code,this.endsAt=t.endsAt,this.offers=this.#e(t.offers),this.mainOffer=this.offers?.at(0),this.redeemCode=t.redeemCode??null,this.startsAt=t.startsAt}async applyToCart(t){let e=t;for(let r of this.offers)e=await r.applyToCart(t);return e}async unapplyFromCart(t){let e=t;for(let r of this.offers)e=await r.unapplyFromCart(t);return e}async applyToPrice(t,e,r){for(let s of this.offers)await s.applyToPrice(t,e,r);return t}async applyToProduct(t,e){for(let r of this.offers)await r.applyToProduct(t,e);return t}getCartEligibility(t){return!!this.mainOffer&&this.mainOffer.getCartEligibility(t)}isCartEntitled(t){return this.offers.some(e=>e.isCartEntitled(t))}isCartEligible(t){return this.offers.some(e=>e.isCartEligible(t))}isCartItemEntitled(t){return this.offers.some(e=>e.isCartItemEntitled(t))}isCollectionEntitled(t){return this.offers.some(e=>e.isCollectionEntitled(t))}isProductEntitled(t,e){return this.offers.some(r=>r.isProductEntitled(t,e))}isShownInCart(t,e){return this.offers.some(r=>r.isShownInCart(t,e))}isShownInCartItem(t,e){return this.offers.some(r=>r.isShownInCartItem(t,e))}isShownInCollection(t,e){return this.offers.some(r=>r.isShownInCollection(t,e))}isShownInProduct(t,e,r){return this.offers.some(s=>s.isShownInProduct(t,e,r))}isEveryOfferOfDiscountClass(t){return this.offers.every(e=>t===e.discountClass)}toJSON(){return this.#t}#e(i){return Object.values(i??[]).map(i=>"ORDER"===i.discountClass?new OrderOffer(i):i.discountValue?.type==="Gift"?new GiftOffer(i):i.discountValue?.type==="DiscountMultiValue"?new MultiValueOffer(i):new ProductOffer(i))}}function getXMinutesFromNow(e){return new Date().getTime()+6e4*e}let promotion_e=logger.createSubLogger("promotion"),i=null;function getActivePromotion(){let o=window.localStorage.getItem("abra:active-promotion");if(o)try{let t=JSON.parse(o);!(t.expiresAt>=Date.now())&&t.promotion&&t.promotion.code?window.localStorage.removeItem("abra:active-promotion"):setActivePromotion(t.promotion)}catch(o){promotion_e.error("promotion cache is corrupt, clearing cache"),promotion_e.error(o),window.localStorage.removeItem("abra:active-promotion")}return i}function setActivePromotion(o){return i=new Promotion(o),window.localStorage.setItem("abra:active-promotion",JSON.stringify({expiresAt:getXMinutesFromNow(30),promotion:o})),i}function clearActivePromotion(){window.localStorage.removeItem("abra:active-promotion"),i=null}function calculateUnitDiscount(t,o,e,i){void 0===i&&(i=1);let c=0;return t&&(c=o/e/i),c}let castDecimalToPercentString=t=>`${Math.floor(100*t).toFixed(0)}%`,VARIABLE_REGEX=/{{(.*?)}}/g;function compile(template,variables){let lines=template.split("\n"),outputLines=[],controlFlowStack=[];for(let lineNumber=0;lineNumber<lines.length;lineNumber++){var line;let line1=lines[lineNumber],processedLine=(((line=line1).includes("{% ")||controlFlowStack.length>0)&&(line=function(line,variables,controlFlowStack){let processedChars=[],lineLength=line.length,cursor=0;for(;cursor<lineLength;){var cursor1;let char=line[cursor];if(cursor1=cursor,"{"===char&&"{%"===line.slice(cursor1,cursor1+2)){let closingIndex=line.indexOf("%}",cursor+2);if(-1!==closingIndex){let tag=line.slice(cursor,closingIndex+2);if(tag.startsWith("{% if ")){let ifCondition=line.slice(cursor+6,closingIndex).trim(),ifConditionResult=function(condition,variables){let parts=condition.split(" ");if(1===parts.length){let part=isLiteral(parts[0])?evaluateLiteral(parts[0]):coerceVariableValue(evaluateVariable(parts[0],variables));return!!part}let left=isLiteral(parts[0])?evaluateLiteral(parts[0]):coerceVariableValue(evaluateVariable(parts[0],variables)),operator=parts[1],right=isLiteral(parts[2])?evaluateLiteral(parts[2]):coerceVariableValue(evaluateVariable(parts[2],variables));switch(operator){case"==":return equals(left,right);case"!=":return!equals(left,right);case">":return!!(left&&right&&left>right);case">=":return!!(left&&right&&left>=right);case"<":return!!(left&&right&&left<right);case"<=":return!!(left&&right&&left<=right);default:return!1}}(ifCondition,variables);controlFlowStack.push(ifConditionResult),cursor=closingIndex+2;continue}if(tag.startsWith("{% elseif "));else if(tag.startsWith("{% else"));else if("{% endif %}"===tag){controlFlowStack.pop(),cursor=closingIndex+2;continue}}}let controlFlowLength=controlFlowStack.length;if(controlFlowLength>0&&!1===controlFlowStack[controlFlowLength-1]){let endIfIndex=line.indexOf("{% endif %}");-1!==endIfIndex&&(controlFlowStack.pop(),cursor=endIfIndex+11-1)}else controlFlowLength>0&&controlFlowStack.every(value=>value)?processedChars.push(char):0===controlFlowLength&&processedChars.push(char);cursor++}return processedChars.join("")}(line,variables,controlFlowStack)),line.includes("{{")&&(line=function(line,variables){let matches=line.match(VARIABLE_REGEX);if(!matches)return line;for(let match of matches){let variable=match.slice(2,-2).trim(),value=evaluateVariable(variable,variables);line=line.replace(match,value?value.toString():"")}return line}(line,variables)),line);outputLines.push(processedLine)}return outputLines.join("\n").trim()}function evaluateVariable(variable,variables){let value;if(variable.includes(".")){let parts=variable.split(".");value=parts.reduce((acc,part)=>acc&&"object"==typeof acc&&part in acc?acc[part]:"",variables)}else value=variables[variable];return void 0===value?"":value}function coerceVariableValue(value){if("string"==typeof value){if(isStringNumber(value))return parseFloat(value);if("true"===value)return!0;if("false"===value)return!1}return value}function evaluateLiteral(variable){return variable.startsWith('"')?variable.substring(1,variable.length-1):"true"===variable||"false"!==variable&&("nil"===variable?null:"empty"===variable?null:parseFloat(variable))}function isLiteral(variable){return!!(isStringNumber(variable)||variable.startsWith('"'))||"nil"===variable||"empty"===variable}function isStringNumber(value){return!!parseFloat(value)}function equals(left,right){return null===left?compareNull(right):null===right?compareNull(left):left==right}function compareNull(value){return null==value||!1===value||""===value||Array.isArray(value)&&0===value.length||"object"==typeof value&&0===Object.keys(value).length}function generateDefaultBlockProps(t){let{promotion:e,offerState:o,cart:i,product:r,collectionHandle:n}=t;return{code:e?e.displayCode:"",currency:{iso_code:window.Abra.currency},redeemCode:e?e.redeemCode:"",offer:{progress_total:o?.progress?.total,progress_remaining:o?.progress?.remainder},discount_amount:function(i){let{offer:r,product:n,cart:a,collectionHandle:c}=i,l=r?.discountValue;if(!l)return"";let u="";if("DiscountAmount"===l.type)u=money_formatMoney(l.discountAmount.cents);else if("DiscountOnQuantity"===l.type)u=castDecimalToPercentString(l.effect.percentage);else if("DiscountPercentage"===l.type)u=castDecimalToPercentString(l.percentage);else if("Gift"===l.type)u="";else if("DiscountMultiValue"===l.type){let{maxDiscount:i,maxDiscountType:r}=function(t){let{discountObject:e,product:o,collectionHandle:i,cart:r}=t,n=e.productDiscounts,a=e.variantDiscounts,c=[...n,...a];if(i&&"collections"in e){let t=e.collections.reduce((t,e,o)=>(e===i&&t.push(o),t),[]);c=n.filter((e,o)=>t.includes(o))}else o?c=[...e.productDiscounts.filter(t=>t.products.includes(o.handle)),...e.variantDiscounts.filter(t=>!o.variants||t.variants.some(t=>o.variants.some(e=>e.id===t)))]:r&&(c=[...e.productDiscounts.filter(t=>t.products.some(t=>r.items.some(e=>e.handle===t))),...e.variantDiscounts.filter(t=>t.variants.some(t=>r.items.some(e=>e.variantId===t)))]);return(c=c.map(t=>({value:t.value}))).reduce((t,e)=>{if("DiscountPercentage"===e.value.type){if(e.value.percentage>=parseFloat(t.maxDiscount))return{maxDiscount:e.value.percentage.toString(),maxDiscountType:"%"}}else if("DiscountAmount"===e.value.type&&parseFloat(e.value.discountAmount.amount)>parseFloat(t.maxDiscount))return{maxDiscount:e.value.discountAmount.amount,maxDiscountType:"$"};return t},{maxDiscount:"0",maxDiscountType:"%"})}({discountObject:l,product:n,collectionHandle:c,cart:a});u="$"===r?money_formatMoney(i):i+"%"}return u}({offer:e?.offers[0],product:r,cart:i,collectionHandle:n})}}function includesVars(t){for(var e=arguments.length,o=Array(e>1?e-1:0),i=1;i<e;i++)o[i-1]=arguments[i];return o.some(e=>!!(t?.includes(`{{${e.toString()}}}`)||t?.includes(`{{ ${e.toString()} }}`)))}class AnnouncementBarBlock{static #t=this.validate=t=>({errors:!1,config:t});#i;constructor(i,o){this.#i=logger.createSubLogger("blocks/announcement-bar"),this.applied=!1,this.config=o,this.id=i,this.promotion=null,this.type=o.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}apply(t){if(void 0===t&&(t={}),this.#i.debug("applying",{id:this.id,config:this.config}),this.#o(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.config.persistentState){let t=this.config.states?.at(0);t&&(t.text=compile(t.text,generateDefaultBlockProps({promotion:this.promotion})),window.Abra.AnnouncementBar.show(t))}return this.applied=!0,!0}undo(){return this.#i.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),window.Abra.AnnouncementBar.hide(),this.applied=!1,!0}#o(t){this.promotion=t.promotion??getActivePromotion()}}async function fetchProductByHandle(o,t){let{logger:r}=void 0===t?{}:t;if(window.Abra?.cache.products.has(o)){let t=window.Abra?.cache.products.get(o);return r?.debug(`loading product ${o} from cache`,t),t}r?.debug(`loading product ${o} from network`);let e=await fetch(window.Shopify.routes.root+`products/${o}.js?_abraignore=1`,{headers:{"Content-Type":"application/json"}});if(!e.ok){r?.error(`product failed to fetch: status=${e.status}`,{handle:o});return}let n=await e.json();if(!n?.id){r?.error("product not found on Shopify",{handle:o});return}return window.Abra.cacheProduct(o,n)}function findVariantId(t){let i;let e=t?.closest("[data-variant-id]");if(e&&(i=e.getAttribute("data-variant-id")||void 0))return i;let a=function(n){void 0===n&&(n=window.location.href);let{searchParams:t}=new URL(n),i=t.get("modal-variant"),e=t.get("variant");return i??e??void 0}();return a}function findVariant(n,t){return n.find(n=>n.id==t)}class Price{get compareAtTotalDiscount(){return this.compareAt-this.original+this.originalTotalDiscount}get final(){let i=this.original-this.originalTotalDiscount;return i>=0?i:0}constructor(i,t){this.compareAt=t??i,this.original=i,this.originalTotalDiscount=0}discount(i){return this.originalTotalDiscount+i>this.original?this.originalTotalDiscount=this.original:this.originalTotalDiscount+=i,this}merge(i){return this.compareAt+=i.compareAt,this.original+=i.original,this.originalTotalDiscount+=i.originalTotalDiscount,this}multiply(i){return this.compareAt=this.compareAt*i,this.original=this.original*i,this.originalTotalDiscount=this.originalTotalDiscount*i,this}divide(i){return this.compareAt=this.compareAt/i,this.original=this.original/i,this.originalTotalDiscount=this.originalTotalDiscount/i,this}clone(){let i=new Price(0,0);return i.compareAt=this.compareAt,i.original=this.original,i.originalTotalDiscount=this.originalTotalDiscount,i}toJSON(){return{compareAt:this.compareAt,compareAtTotalDiscount:Math.floor(this.compareAtTotalDiscount),final:Math.ceil(this.final),original:this.original,originalTotalDiscount:Math.floor(this.originalTotalDiscount)}}}class Variant{constructor(e){this.codes=new Set,this.handle=e.handle,this.id=e.id,this.name=e.name,this.price=e.price?new Price(e.price,e.compareAtPrice):void 0,this.unitPrice=e.unitPrice?new Price(e.unitPrice):void 0,this.unitPriceMeasurement=e.unitPriceMeasurement}discount(e){if(this.price?.discount(e),this.price&&this.unitPrice){let n=calculateUnitDiscount(this.unitPrice,e,1,this.unitPriceMeasurement?.quantityValue);this.unitPrice.discount(n)}return this}}class Product{get minFinalPrice(){return this.variants.map(t=>t.price?.final).filter(t=>void 0!==t).sort((t,e)=>t-e)[0]}get url(){return`/products/${this.handle}`}constructor(t){this.discounted=!1,this.handle=t.handle,this.id=t.id,this.featuredImage=t.featuredImage,this.title=t.title,this.variants=t.variants.map(t=>new Variant(t))}discount(t,e){let i=this.getFirstOrSelectedVariant(e);return i&&(i.discount(t),this.discounted=!0),this}doesPriceVary(){let t=this.variants[0];return this.variants.some(e=>t.price?.original!==e.price?.original)}findVariant(e){return findVariant(this.variants,e)}getFirstOrSelectedVariant(t){return t&&this.findVariant(t)||this.variants[0]}getPrice(t){let e=this.getFirstOrSelectedVariant(t);return e?.price}getUnitPrice(t){let e=this.getFirstOrSelectedVariant(t);return e?.unitPrice}getUnitPriceMeasurement(t){let e=this.getFirstOrSelectedVariant(t);return e?.unitPriceMeasurement}}async function fetchCart(t){let{logger:o}=void 0===t?{}:t,e=await fetch(window.Shopify.routes.root+"cart.js?_abraignore=1",{headers:{"Content-Type":"application/json"}});if(!e.ok)return o?.error(`cart failed to fetch: status=${e.status}`),null;{let t=await e.json();return t??null}}async function addItemToCart(o,e){let{variant:r,quantity:a,properties:n}=o,{logger:i}=void 0===e?{}:e,s=await fetch(window.Shopify.routes.root+"cart/add.js?_abraignore=1",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:safeParseInt(r),quantity:a,...n?{properties:{...n.offer?{__abra:JSON.stringify({offer:n.offer})}:{},...n.hideQuantity?{__hide_quantity:n.hideQuantity}:{}}}:{}})});if(!s.ok)return i?.error(`add to cart failed: status=${s.status}`),null;{let t=await s.json();return t??null}}async function removeItemFromCart(t,o){let{logger:e}=void 0===o?{}:o,r=await fetch(window.Shopify.routes.root+"cart/change.js?_abraignore=1",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,quantity:0})});return r.ok||e?.error(`remove from cart failed: status=${r.status}`),r.ok}async function fetchVariant(r,a,n){let{logger:o}=void 0===n?{}:n;if(window.Abra?.cache.products.has(r)){let n=window.Abra?.cache.products.get(r);return o?.debug(`loading variant ${r} from cache`,n),findVariant(n.variants,a)}o?.debug(`loading variant ${r} from network`);let i=await fetch(window.Shopify.routes.root+`products/${r}.js?_abraignore=1`,{headers:{"Content-Type":"application/json"}});if(!i.ok){o?.error(`variant failed to fetch: status=${i.status}`);return}let e=await i.json();if(!e?.id){o?.error("variant not found on Shopify");return}let c=window.Abra.cacheProduct(r,e);return findVariant(c.variants,a)}class CartItem{get code(){return Array.from(this.codes).join(" | ")}get price(){return this.linePrice.clone().divide(this.quantity)}constructor(e,t){this.codes=new Set,this.discounted=!1,this.discounts=e.discounts,this.handle=e.handle,this.id=e.id,this.key=e.key,this.linePrice=new Price(e.original_line_price,t?.price?.compareAt?t.price.compareAt*e.quantity:e.original_line_price),this.properties=e.properties,this.quantity=e.quantity,this.type=e.selling_plan_allocation?.selling_plan?"SELLING_PLAN":"ONE_TIME_PURCHASE",this.unitPrice=t?.unitPrice,this.unitPriceMeasurement=e.unit_price_measurement?{quantityValue:e.unit_price_measurement.quantity_value?parseFloat(e.unit_price_measurement.quantity_value):void 0,referenceUnit:e.unit_price_measurement.reference_unit,referenceValue:e.unit_price_measurement.reference_value}:void 0,this.url=e.url,this.variantId=e.variant_id.toString(),this.isGiftCard=e.gift_card}discount(e){if(0===e)return this;if(this.linePrice.discount(e),this.discounted=!0,this.unitPrice){let i=calculateUnitDiscount(this.unitPrice,e,this.quantity,this.unitPriceMeasurement?.quantityValue);this.unitPrice.discount(i)}return this}isOneTimePurchase(){return"ONE_TIME_PURCHASE"===this.type}isSellingPlan(){return"SELLING_PLAN"===this.type}getAbraProperty(){if(!this.properties)return null;let e=this.properties.__abra;try{if(e)return JSON.parse(e);return null}catch(e){return console.error(e),null}}toJSON(){return{code:this.code,codes:Array.from(this.codes),discounted:this.discounted,handle:this.handle,id:this.id,key:this.key,linePrice:this.linePrice.toJSON(),properties:this.properties,price:this.price.toJSON(),quantity:this.quantity,type:this.type,unitPrice:this.unitPrice?.toJSON(),unitPriceMeasurement:this.unitPriceMeasurement,url:this.url,variantId:this.variantId}}}async function createCartItem(t,i){void 0===i&&(i={});let n=await fetchVariant(t.handle,t.variant_id,i);return new CartItem(t,n?new Variant(n):null)}class Cart{get code(){return Array.from(this.codes).join(" | ")}get subtotalPrice(){let t=new Price(0,0);for(let e of this.items)t.merge(e.linePrice);return t}constructor(t,e){this.attributes=t.attributes,this.codes=new Set,this.currency=t.currency,this.itemCount=t.item_count,this.items=e,this.token=t.token}async addItem(e){let r={variant:e.variant,quantity:e.quantity};"bullandcleaver.myshopify.com"===window.Shopify.shop&&(r.properties=e.properties);let o=await addItemToCart(r);if(o){e.properties?.offer&&(o.properties={...e.properties?.offer?{__abra:JSON.stringify({offer:e.properties.offer})}:{},...e.properties?.hideQuantity?{__hide_quantity:e.properties.hideQuantity}:{}},o.quantity=e.quantity,o.original_line_price=o.original_price*e.quantity);let t=await createCartItem(o);this.items.push(t),this.itemCount+=e.quantity}return o}async removeItemByKey(t){let i=await removeItemFromCart(t);return i&&(this.items=this.items.filter(e=>e.key!==t),this.itemCount-=1),i}}async function createCart(t){let e=await Promise.all(t.items.map(t=>createCartItem(t)));return new Cart(t,e)}async function attributeCartToCode(t,r){let o=window.sessionStorage.getItem("abra:attributed_at");if(!o){var t1;t1=o=new Date().toISOString(),window.sessionStorage.setItem("abra:attributed_at",t1)}let n=await fetch(window.Shopify.routes.root+"cart/update.js?_abraignore=1",{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({attributes:{__abra:JSON.stringify({code:t,redeemCode:r,attributedAt:o})}})});return n.ok}async function getCart(a){let{logger:e}=void 0===a?{}:a,i=getActivePromotion(),n=await fetchCart({logger:e}),s=null;return n&&(s=await createCart(n),i&&i.isCartEligible(s)?s=await i.applyToCart(s):i&&(s=await i.unapplyFromCart(s))),s}function r(t){void 0===t&&(t=window.location.href);let r=t.split("/"),e=r.indexOf("products");if(-1===e)return;let n=r.indexOf("products")+1,c=r[n].split("?")[0];return c}function findProductHandle(e,n){let c;if(!e)return r();let o="closest";if(n){let t=e.closest(n);t&&(t.setAttribute("data-abra-container",n),e=t,o="querySelector")}if("a"===e.tagName&&(c=r(e.href)))return c;let i=e[o]('[href*="/products/"]');if(i&&(c=r(i.href)))return c;let f=e.getAttribute("[data-product-handle]");if(f&&(c=f))return c;let d=e[o]("[data-product-handle]");if(d&&(c=d.getAttribute("data-product-handle")||void 0))return c;let s=e[o]('[class$="card"], [class~="card"], [class$="Card"], [class~="Card"]');if(s){let t=s.querySelector('[href*="/products/"]');if(t&&(c=r(t.href)))return c}let u=e[o]('[class*="grid-item"], [class*="product-block"]');if(u){let t=u.querySelector('[href*="/products/"]');if(t&&(c=r(t.href)))return c}let a=e[o]('form[action="/cart"]');return a?c:c=r()}function findAllProductsInDOM(){let t=new Set;return document.querySelectorAll("a").forEach(r=>{let e=findProductHandle(r);e&&t.add(e)}),Array.from(t)}async function switchOnTemplate(t,e){if(t){if("all"===t)await e.all();else if(t.startsWith("product"))await e.product();else if(t.startsWith("collection"))await e.collection();else if(t.startsWith("index"))await e.index();else if(t.startsWith("cart"))await e.cart();else throw Error("template isn't supported")}}class BannerBlock{static #t=this.validate=t=>({errors:!1,config:t});#i;constructor(i,e,o){this.#i=logger.createSubLogger("blocks/banner"),this.applied=!1,this.cart=null,this.config=e,this.id=i,this.page=o.page,this.promotion=null,this.type=e.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}async apply(t){return void 0===t&&(t={}),this.#i.debug("applying",{id:this.id,config:this.config}),await this.#e(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.page?.fullName&&await switchOnTemplate(this.page.fullName,{all:()=>this.#o(),cart:()=>this.#n(),collection:()=>this.#s(),index:()=>this.#r(),product:()=>this.#a()}),this.applied=!0,!0}undo(){return this.#i.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),window.Abra.Banner.hide(this.config.name),this.applied=!1,!0}async #o(){this.config.persistentState?this.#l({}):this.#h({})}async #n(){this.promotion&&this.cart&&(this.config.persistentState?this.#l({cart:this.cart}):this.#h({cart:this.cart}))}async #s(){let t=findCollectionHandle(),i=this.page?.findAllProductsInDOM(),e=!!(t&&this.promotion?.isCollectionEntitled(t)),o=!!i?.some(t=>this.promotion?.isProductEntitled(t,null));e||o?this.config.persistentState?this.#l({collectionHandle:t}):this.#h({collectionHandle:t}):(this.#i.debug("products on collection page aren't entitled, hiding banner"),window.Abra.Banner.hide(this.config.name))}async #r(){this.config.persistentState?this.#l({}):this.#h({})}async #a(){let t=findProductHandle();if(!t){this.#i.debug("skipping element, product handle not found");return}let o=null;try{let n=await fetchProductByHandle(t,{logger:this.#i});n&&(o=new Product(n))}catch(t){this.#i.error("product failed to fetch",{error:t})}if(!o){this.#i.debug("skipping element, product can't be found");return}let n=!!this.promotion?.isProductEntitled(o.handle,o.getFirstOrSelectedVariant(findVariantId()).id);n?this.config.persistentState?this.#l({product:o}):this.#h({product:o}):(this.#i.debug("product isn't entitled, hiding banner"),window.Abra.Banner.hide(this.config.name))}async #e(t){this.promotion=t.promotion??getActivePromotion(),this.cart=t.cart??await getCart()}#l(t){let{cart:i,collectionHandle:e,product:o}=t;if(!this.promotion)return;let n=this.config.states?.at(0);n?(n.text=compile(n.text,generateDefaultBlockProps({promotion:this.promotion,cart:i,collectionHandle:e,product:o})),window.Abra.Banner.show(this.config.name,n)):window.Abra.Banner.hide(this.config.name)}async #h(t){let{cart:e,collectionHandle:o,product:n}=t;if(!this.promotion||!this.cart)return;let s=this.promotion.getCartEligibility(this.cart);if(!s){window.Abra.Banner.hide(this.config.name);return}this.#i.debug(`targetting state ${s.state}`,{targetState:s,states:this.config.states});let l=this.config.states?.find(t=>{let{state:i}=t;return i===s.state});if(!l){window.Abra.Banner.hide(this.config.name);return}if(l.text=compile(l.text,generateDefaultBlockProps({promotion:this.promotion,offerState:s,cart:e,collectionHandle:o,product:n})),this.promotion.mainOffer?.discountValue?.type==="Gift"){let t=this.promotion.mainOffer.discountValue.products?.at(0);if(t){let e=t.variants?.at(0);if(e)try{let o=await fetchProductByHandle(t.handle,{logger:this.#i});if(o?.variants){let t=findVariant(o.variants,e.id);t?l={...l,offer:{variantId:t.id,productHandle:t.handle,title:t.name,price:money_formatMoney(t.price),image:o.featuredImage?{src:o.featuredImage}:void 0,progress:s.progress?.percentage}}:this.#i.warn("gift variant missing from Shopify",{variant:t,product:o})}else this.#i.warn("gift product missing variants from Shopify",{handle:t.handle,product:o})}catch(t){window.Abra.Notification.show({content:"Error: Your free gift isn't available"}),this.#i.error("failed to fetch gift from Shopify"),this.#i.error(t)}else this.#i.warn("gift variant not found")}else this.#i.warn("gift product not found")}window.Abra.Banner.show(this.config.name,l)}}var doc="undefined"==typeof document?void 0:document,HAS_TEMPLATE_SUPPORT=!!doc&&"content"in doc.createElement("template"),HAS_RANGE_SUPPORT=!!doc&&doc.createRange&&"createContextualFragment"in doc.createRange();function compareNodeNames(fromEl,toEl){var fromCodeStart,toCodeStart,fromNodeName=fromEl.nodeName,toNodeName=toEl.nodeName;return fromNodeName===toNodeName||((fromCodeStart=fromNodeName.charCodeAt(0),toCodeStart=toNodeName.charCodeAt(0),fromCodeStart<=90&&toCodeStart>=97)?fromNodeName===toNodeName.toUpperCase():toCodeStart<=90&&fromCodeStart>=97&&toNodeName===fromNodeName.toUpperCase())}function syncBooleanAttrProp(fromEl,toEl,name){fromEl[name]!==toEl[name]&&(fromEl[name]=toEl[name],fromEl[name]?fromEl.setAttribute(name,""):fromEl.removeAttribute(name))}var specialElHandlers={OPTION:function(fromEl,toEl){var parentNode=fromEl.parentNode;if(parentNode){var parentName=parentNode.nodeName.toUpperCase();"OPTGROUP"===parentName&&(parentName=(parentNode=parentNode.parentNode)&&parentNode.nodeName.toUpperCase()),"SELECT"!==parentName||parentNode.hasAttribute("multiple")||(fromEl.hasAttribute("selected")&&!toEl.selected&&(fromEl.setAttribute("selected","selected"),fromEl.removeAttribute("selected")),parentNode.selectedIndex=-1)}syncBooleanAttrProp(fromEl,toEl,"selected")},INPUT:function(fromEl,toEl){syncBooleanAttrProp(fromEl,toEl,"checked"),syncBooleanAttrProp(fromEl,toEl,"disabled"),fromEl.value!==toEl.value&&(fromEl.value=toEl.value),toEl.hasAttribute("value")||fromEl.removeAttribute("value")},TEXTAREA:function(fromEl,toEl){var newValue=toEl.value;fromEl.value!==newValue&&(fromEl.value=newValue);var firstChild=fromEl.firstChild;if(firstChild){var oldValue=firstChild.nodeValue;if(oldValue==newValue||!newValue&&oldValue==fromEl.placeholder)return;firstChild.nodeValue=newValue}},SELECT:function(fromEl,toEl){if(!toEl.hasAttribute("multiple")){for(var optgroup,nodeName,selectedIndex=-1,i=0,curChild=fromEl.firstChild;curChild;)if("OPTGROUP"===(nodeName=curChild.nodeName&&curChild.nodeName.toUpperCase()))curChild=(optgroup=curChild).firstChild;else{if("OPTION"===nodeName){if(curChild.hasAttribute("selected")){selectedIndex=i;break}i++}(curChild=curChild.nextSibling)||!optgroup||(curChild=optgroup.nextSibling,optgroup=null)}fromEl.selectedIndex=selectedIndex}}};function noop(){}function defaultGetNodeKey(node){if(node)return node.getAttribute&&node.getAttribute("id")||node.id}var morphdom=(morphAttrs=function(fromNode,toNode){var attr,attrName,attrNamespaceURI,attrValue,toNodeAttrs=toNode.attributes;if(11!==toNode.nodeType&&11!==fromNode.nodeType){for(var i=toNodeAttrs.length-1;i>=0;i--)attrName=(attr=toNodeAttrs[i]).name,attrNamespaceURI=attr.namespaceURI,attrValue=attr.value,attrNamespaceURI?(attrName=attr.localName||attrName,fromNode.getAttributeNS(attrNamespaceURI,attrName)!==attrValue&&("xmlns"===attr.prefix&&(attrName=attr.name),fromNode.setAttributeNS(attrNamespaceURI,attrName,attrValue))):fromNode.getAttribute(attrName)!==attrValue&&fromNode.setAttribute(attrName,attrValue);for(var fromNodeAttrs=fromNode.attributes,d=fromNodeAttrs.length-1;d>=0;d--)attrName=(attr=fromNodeAttrs[d]).name,(attrNamespaceURI=attr.namespaceURI)?(attrName=attr.localName||attrName,toNode.hasAttributeNS(attrNamespaceURI,attrName)||fromNode.removeAttributeNS(attrNamespaceURI,attrName)):toNode.hasAttribute(attrName)||fromNode.removeAttribute(attrName)}},function(fromNode,toNode,options){if(options||(options={}),"string"==typeof toNode){if("#document"===fromNode.nodeName||"HTML"===fromNode.nodeName||"BODY"===fromNode.nodeName){var str,str1,template,str2,str3,fragment,name,namespaceURI,toNodeHtml=toNode;(toNode=doc.createElement("html")).innerHTML=toNodeHtml}else str=(str=toNode).trim(),toNode=HAS_TEMPLATE_SUPPORT?(str1=str,(template=doc.createElement("template")).innerHTML=str1,template.content.childNodes[0]):HAS_RANGE_SUPPORT?(str2=str,range||(range=doc.createRange()).selectNode(doc.body),range.createContextualFragment(str2).childNodes[0]):(str3=str,(fragment=doc.createElement("body")).innerHTML=str3,fragment.childNodes[0])}else 11===toNode.nodeType&&(toNode=toNode.firstElementChild);var getNodeKey=options.getNodeKey||defaultGetNodeKey,onBeforeNodeAdded=options.onBeforeNodeAdded||noop,onNodeAdded=options.onNodeAdded||noop,onBeforeElUpdated=options.onBeforeElUpdated||noop,onElUpdated=options.onElUpdated||noop,onBeforeNodeDiscarded=options.onBeforeNodeDiscarded||noop,onNodeDiscarded=options.onNodeDiscarded||noop,onBeforeElChildrenUpdated=options.onBeforeElChildrenUpdated||noop,skipFromChildren=options.skipFromChildren||noop,addChild=options.addChild||function(parent,child){return parent.appendChild(child)},childrenOnly=!0===options.childrenOnly,fromNodesLookup=Object.create(null),keyedRemovalList=[];function addKeyedRemoval(key){keyedRemovalList.push(key)}function removeNode(node,parentNode,skipKeyedNodes){!1!==onBeforeNodeDiscarded(node)&&(parentNode&&parentNode.removeChild(node),onNodeDiscarded(node),function walkDiscardedChildNodes(node,skipKeyedNodes){if(1===node.nodeType)for(var curChild=node.firstChild;curChild;){var key=void 0;skipKeyedNodes&&(key=getNodeKey(curChild))?addKeyedRemoval(key):(onNodeDiscarded(curChild),curChild.firstChild&&walkDiscardedChildNodes(curChild,skipKeyedNodes)),curChild=curChild.nextSibling}}(node,skipKeyedNodes))}!function indexTree(node){if(1===node.nodeType||11===node.nodeType)for(var curChild=node.firstChild;curChild;){var key=getNodeKey(curChild);key&&(fromNodesLookup[key]=curChild),indexTree(curChild),curChild=curChild.nextSibling}}(fromNode);var morphedNode=fromNode,morphedNodeType=morphedNode.nodeType,toNodeType=toNode.nodeType;if(!childrenOnly){if(1===morphedNodeType)1===toNodeType?compareNodeNames(fromNode,toNode)||(onNodeDiscarded(fromNode),morphedNode=function(fromEl,toEl){for(var curChild=fromEl.firstChild;curChild;){var nextChild=curChild.nextSibling;toEl.appendChild(curChild),curChild=nextChild}return toEl}(fromNode,(name=toNode.nodeName,(namespaceURI=toNode.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==namespaceURI?doc.createElementNS(namespaceURI,name):doc.createElement(name)))):morphedNode=toNode;else if(3===morphedNodeType||8===morphedNodeType){if(toNodeType===morphedNodeType)return morphedNode.nodeValue!==toNode.nodeValue&&(morphedNode.nodeValue=toNode.nodeValue),morphedNode;morphedNode=toNode}}if(morphedNode===toNode)onNodeDiscarded(fromNode);else{if(toNode.isSameNode&&toNode.isSameNode(morphedNode))return;if(function morphEl(fromEl,toEl,childrenOnly){var toElKey=getNodeKey(toEl);toElKey&&delete fromNodesLookup[toElKey],(childrenOnly||!1!==onBeforeElUpdated(fromEl,toEl)&&(morphAttrs(fromEl,toEl),onElUpdated(fromEl),!1!==onBeforeElChildrenUpdated(fromEl,toEl)))&&("TEXTAREA"!==fromEl.nodeName?function(fromEl,toEl){var curToNodeKey,curFromNodeKey,fromNextSibling,toNextSibling,matchingFromEl,skipFrom=skipFromChildren(fromEl,toEl),curToNodeChild=toEl.firstChild,curFromNodeChild=fromEl.firstChild;outer:for(;curToNodeChild;){for(toNextSibling=curToNodeChild.nextSibling,curToNodeKey=getNodeKey(curToNodeChild);!skipFrom&&curFromNodeChild;){if(fromNextSibling=curFromNodeChild.nextSibling,curToNodeChild.isSameNode&&curToNodeChild.isSameNode(curFromNodeChild)){curToNodeChild=toNextSibling,curFromNodeChild=fromNextSibling;continue outer}curFromNodeKey=getNodeKey(curFromNodeChild);var curFromNodeType=curFromNodeChild.nodeType,isCompatible=void 0;if(curFromNodeType===curToNodeChild.nodeType&&(1===curFromNodeType?(curToNodeKey?curToNodeKey!==curFromNodeKey&&((matchingFromEl=fromNodesLookup[curToNodeKey])?fromNextSibling===matchingFromEl?isCompatible=!1:(fromEl.insertBefore(matchingFromEl,curFromNodeChild),curFromNodeKey?addKeyedRemoval(curFromNodeKey):removeNode(curFromNodeChild,fromEl,!0),curFromNodeChild=matchingFromEl):isCompatible=!1):curFromNodeKey&&(isCompatible=!1),(isCompatible=!1!==isCompatible&&compareNodeNames(curFromNodeChild,curToNodeChild))&&morphEl(curFromNodeChild,curToNodeChild)):(3===curFromNodeType||8==curFromNodeType)&&(isCompatible=!0,curFromNodeChild.nodeValue!==curToNodeChild.nodeValue&&(curFromNodeChild.nodeValue=curToNodeChild.nodeValue))),isCompatible){curToNodeChild=toNextSibling,curFromNodeChild=fromNextSibling;continue outer}curFromNodeKey?addKeyedRemoval(curFromNodeKey):removeNode(curFromNodeChild,fromEl,!0),curFromNodeChild=fromNextSibling}if(curToNodeKey&&(matchingFromEl=fromNodesLookup[curToNodeKey])&&compareNodeNames(matchingFromEl,curToNodeChild))skipFrom||addChild(fromEl,matchingFromEl),morphEl(matchingFromEl,curToNodeChild);else{var onBeforeNodeAddedResult=onBeforeNodeAdded(curToNodeChild);!1!==onBeforeNodeAddedResult&&(onBeforeNodeAddedResult&&(curToNodeChild=onBeforeNodeAddedResult),curToNodeChild.actualize&&(curToNodeChild=curToNodeChild.actualize(fromEl.ownerDocument||doc)),addChild(fromEl,curToNodeChild),function handleNodeAdded(el){onNodeAdded(el);for(var curChild=el.firstChild;curChild;){var nextSibling=curChild.nextSibling,key=getNodeKey(curChild);if(key){var unmatchedFromEl=fromNodesLookup[key];unmatchedFromEl&&compareNodeNames(curChild,unmatchedFromEl)?(curChild.parentNode.replaceChild(unmatchedFromEl,curChild),morphEl(unmatchedFromEl,curChild)):handleNodeAdded(curChild)}else handleNodeAdded(curChild);curChild=nextSibling}}(curToNodeChild))}curToNodeChild=toNextSibling,curFromNodeChild=fromNextSibling}!function(fromEl,curFromNodeChild,curFromNodeKey){for(;curFromNodeChild;){var fromNextSibling=curFromNodeChild.nextSibling;(curFromNodeKey=getNodeKey(curFromNodeChild))?addKeyedRemoval(curFromNodeKey):removeNode(curFromNodeChild,fromEl,!0),curFromNodeChild=fromNextSibling}}(fromEl,curFromNodeChild,curFromNodeKey);var specialElHandler=specialElHandlers[fromEl.nodeName];specialElHandler&&specialElHandler(fromEl,toEl)}(fromEl,toEl):specialElHandlers.TEXTAREA(fromEl,toEl))}(morphedNode,toNode,childrenOnly),keyedRemovalList)for(var i=0,len=keyedRemovalList.length;i<len;i++){var elToRemove=fromNodesLookup[keyedRemovalList[i]];elToRemove&&removeNode(elToRemove,elToRemove.parentNode,!1)}}return!childrenOnly&&morphedNode!==fromNode&&fromNode.parentNode&&(morphedNode.actualize&&(morphedNode=morphedNode.actualize(fromNode.ownerDocument||doc)),fromNode.parentNode.replaceChild(morphedNode,fromNode)),morphedNode});function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,function(arg){var key=function(input,hint){if("object"!=typeof input||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0!==prim){var res=prim.call(input,hint||"default");if("object"!=typeof res)return res;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===hint?String:Number)(input)}(arg,"string");return"symbol"==typeof key?key:String(key)}(descriptor.key),descriptor)}}var Morphel=function(){function Morphel(element){this.element=element,this.originalHTML=element.outerHTML.toString()}var staticProps,_proto=Morphel.prototype;return _proto.morph=function(toNode,options){return morphdom(this.element,toNode,options),this},_proto.restore=function(){return this.originalHTML&&morphdom(this.element,this.originalHTML),this},_defineProperties(Morphel.prototype,[{key:"el",get:function(){return this.element}}]),staticProps&&_defineProperties(Morphel,staticProps),Object.defineProperty(Morphel,"prototype",{writable:!1}),Morphel}();let morphel_esm=function(fromEl,toNode,options){return new Morphel(fromEl).morph(toNode,options)},defaultMorphOptions={onBeforeElUpdated:function(e,t){return!e.isEqualNode(t)}};class CartItemBlock{static #t=this.validate=t=>{let i=[];return(t.item||i.push("'item' is required"),i.length>0)?{errors:i,config:t}:{errors:!1,config:t}};#i;constructor(t,o){this.id=t,this.type=o.type,this.#i=logger.createSubLogger(`blocks/cart-item/${t}`),this.applied=!1,this.cart=null,this.promotion=null,this.config=o,this.morphels=[],this.linePriceMode=includesVars(o.html,"compare_at_line_price")?"compare_at":"original",this.priceMode=includesVars(o.html,"compare_at_price")?"compare_at":"original",this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}async apply(t){return void 0===t&&(t={}),this.#i.debug("applying",{id:this.id,config:this.config}),await this.#o(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.applied=await this.#e(),this.applied}undo(){for(let t of(this.config.onevent&&removeListener(this.config.onevent,this.apply),this.morphels))t.restore();return this.applied=!1,this.morphels=[],!0}async #e(){if(!this.config.item||!this.config.selector||!this.config.html||!this.cart||!this.promotion)return this.#i.debug("block is missing data",{config:this.config,cart:this.cart,promotion:this.promotion}),!1;let i=this.promotion.isCartEligible(this.cart);if(!i){for(let t of(this.#i.debug("cart isn't eligible"),this.morphels))t.restore();return!0}let o=document.querySelectorAll(this.config.item);for(let i=0;i<o.length;i++){let e=this.cart.items[i];if(!e||!this.promotion.isShownInCartItem(this.type,e)||!this.promotion.isCartItemEntitled(e)){this.#i.debug("cart item isn't entitled");continue}if(!e.discounted){this.#i.debug("skipping element, cart item isn't discounted");continue}let n=o[i];n.setAttribute("data-abra-item",this.config.item),n.setAttribute("data-abra-block",this.config.type);let{linePrice:c}=e,h=e.price.toJSON(),a=e.unitPrice?.toJSON(),p=n.querySelectorAll(this.config.selector),m=Array.from(p).map(i=>new Morphel(i));for(let t of m){let i=compile(this.config.html,function(e){let{promotion:o,priceMode:i,linePriceMode:r,linePrice:n,price:a,unitPrice:c,cartItem:l}=e;return{code:o.displayCode,compare_at_line_price:money_formatMoney(n.compareAt),compare_at_price:money_formatMoney(a.compareAt),currency:{iso_code:window.Abra.currency},final_line_price:money_formatMoney(n.final),final_price:money_formatMoney(a.final),final_unit_price:money_formatMoney(c?.final),original_line_price:money_formatMoney(n.original),original_price:money_formatMoney(a.original),original_unit_price:money_formatMoney(c?.original),redeemCode:o.redeemCode??"",quantity:l.quantity,total_discount:money_formatMoney("compare_at"===i?a.compareAtTotalDiscount:a.originalTotalDiscount),total_discount_dollar:"compare_at"===i?money_formatMoney(a.compareAtTotalDiscount):money_formatMoney(a.originalTotalDiscount),total_discount_percentage:String(Math.round("compare_at"===i?a.compareAtTotalDiscount/a.compareAt*100:a.originalTotalDiscount/a.original*100))+"%",total_line_discount:money_formatMoney("compare_at"===r?n.compareAtTotalDiscount:n.originalTotalDiscount),unit_price_measurement:{reference_unit:l.unitPriceMeasurement?.referenceUnit||""},url:l.url}}({promotion:this.promotion,linePriceMode:this.linePriceMode,priceMode:this.priceMode,linePrice:c,price:h,unitPrice:a,cartItem:e}));t.morph(i,defaultMorphOptions),t.el.setAttribute("data-abra-selector",this.config.selector),t.el.setAttribute("data-abra-block",this.config.type)}this.morphels.concat(m)}return!0}async #o(t){this.promotion=t.promotion??getActivePromotion(),this.cart=t.cart??await getCart()}}class CartBlock{static #t=this.validate=t=>{let i=[];return(t.selector||i.push("'selector' is required"),i.length>0)?{errors:i,config:t}:{errors:!1,config:t}};#i;constructor(t,o,e){this.id=t,this.type=o.type,this.#i=logger.createSubLogger(`blocks/cart/${t}`),this.applied=!1,this.config=o,this.cart=null,this.promotion=null,this.morphels=[];let s=Object.values(e.blocks).some(t=>"cart-item"===t.type&&includesVars(t.html,"compare_at_line_price","compare_at_price"));this.priceMode=s?"compare_at":"original",this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}async apply(t){return void 0===t&&(t={}),this.#i.debug("applying",{id:this.id,config:this.config}),await this.#o(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.applied=await this.#e(),this.applied}undo(){for(let t of(this.#i.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),this.morphels))t.restore();return this.applied=!1,this.morphels=[],!0}async #e(){if(!this.promotion||!this.cart||!this.config.selector||!this.config.html)return!1;let t=this.promotion.isCartEligible(this.cart);if(!t){for(let t of(this.#i.debug("cart isn't eligible"),this.morphels))t.restore();return!0}this.#s();let i=this.cart.subtotalPrice.toJSON();for(let t of this.morphels){let o=compile(this.config.html,function(e){let{promotion:o,subtotalPrice:i,priceMode:r}=e;return{code:o.displayCode,currency:{iso_code:window.Abra.currency},compare_at_subtotal_price:money_formatMoney(i.compareAt),final_subtotal_price:money_formatMoney(i.final),original_subtotal_price:money_formatMoney(i.original),redeemCode:o.redeemCode??"",subtotal_price:money_formatMoney(i.final),total_discount:"compare_at"===r?money_formatMoney(i.compareAtTotalDiscount):money_formatMoney(i.originalTotalDiscount),total_discount_dollar:"compare_at"===r?money_formatMoney(i.compareAtTotalDiscount):money_formatMoney(i.originalTotalDiscount),total_discount_percentage:String(Math.round("compare_at"===r?i.compareAtTotalDiscount/i.compareAt*100:i.originalTotalDiscount/i.original*100))+"%"}}({priceMode:this.priceMode,promotion:this.promotion,subtotalPrice:i}));t.morph(o,defaultMorphOptions),t.el.setAttribute("data-abra-selector",this.config.selector),t.el.setAttribute("data-abra-block",this.config.type)}return!0}#s(){if(this.config.selector){let i=Array.from(document.querySelectorAll(this.config.selector));this.morphels=i.map(i=>new Morphel(i))}else this.morphels=[]}async #o(t){this.promotion=t.promotion??getActivePromotion(),this.cart=t.cart??await getCart()}}class DynamicTextBlock{static #t=this.validate=t=>({errors:!1,config:t});#i;constructor(i,e,o){this.#i=logger.createSubLogger("blocks/dynamic-text"),this.applied=!1,this.cart=null,this.config=e,this.id=i,this.page=o.page,this.promotion=null,this.type=e.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}async apply(t){return void 0===t&&(t={}),this.#i.debug("applying",{id:this.id,config:this.config}),await this.#e(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.page?.fullName&&await switchOnTemplate(this.page.fullName,{all:()=>this.#o(),cart:()=>this.#s(),collection:()=>this.#n(),index:()=>this.#r(),product:()=>this.#a()}),this.applied=!0,!0}undo(){return this.#i.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),window.Abra.DynamicText.hide(this.config.name),this.applied=!1,!0}async #o(){this.config.persistentState?this.#h({}):this.#c({})}async #s(){this.promotion&&this.cart&&(this.config.persistentState?this.#h({cart:this.cart}):this.#c({cart:this.cart}))}async #n(){let t=findCollectionHandle(),i=this.page?.findAllProductsInDOM(),e=!!(t&&this.promotion?.isCollectionEntitled(t)),o=!!i?.some(t=>this.promotion?.isProductEntitled(t,null));e||o?this.config.persistentState?this.#h({collectionHandle:t}):this.#c({collectionHandle:t}):window.Abra.DynamicText.hide(this.config.name)}async #r(){this.config.persistentState?this.#h({}):this.#c({})}async #a(){let t=findProductHandle();if(!t){this.#i.debug("skipping element, product handle not found");return}let o=null;try{let s=await fetchProductByHandle(t,{logger:this.#i});s&&(o=new Product(s))}catch(t){this.#i.error("product failed to fetch",{error:t})}if(!o){this.#i.debug("skipping element, product can't be found");return}let s=!!this.promotion?.isProductEntitled(o.handle,o.getFirstOrSelectedVariant(findVariantId()).id);s?this.config.persistentState?this.#h({product:o}):this.#c({product:o}):(this.#i.debug("product isn't entitled, hiding dynamic-text"),window.Abra.DynamicText.hide(this.config.name))}#h(t){let{cart:i,collectionHandle:e,product:o}=t,s=this.config.states?.at(0);if(!s){window.Abra.Banner.hide(this.config.name);return}s.text=compile(s.text,generateDefaultBlockProps({promotion:this.promotion,cart:i,collectionHandle:e,product:o})),window.Abra.DynamicText.show(this.config.name,s)}#c(t){let{cart:i,collectionHandle:e,product:o}=t;if(!this.promotion||!this.cart)return;let s=this.promotion.getCartEligibility(this.cart);if(!s){window.Abra.DynamicText.hide(this.config.name);return}let n=this.config.states?.find(t=>{let{state:i}=t;return i===s.state});if(!n){window.Abra.DynamicText.hide(this.config.name);return}n.text=compile(n.text,generateDefaultBlockProps({promotion:this.promotion,offerState:s,cart:i,collectionHandle:e,product:o})),window.Abra.DynamicText.show(this.config.name,n)}async #e(t){this.promotion=t.promotion??getActivePromotion(),this.cart=t.cart??await getCart()}}class HideBlock{static #t=this.validate=t=>{let e=[];return(t.selector||e.push("'selector' is required"),e.length>0)?{errors:e,config:t}:{errors:!1,config:t}};#e;constructor(e,i){this.#e=logger.createSubLogger(`blocks/hide/${e}`),this.applied=!1,this.config=i,this.id=e,this.type=i.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}apply(){return this.#e.debug("applying",{id:this.id,config:this.config}),this.#i(),this.config.onevent&&addListener(this.config.onevent,this.apply),this.elements?.forEach(t=>{t.setAttribute("data-abra-selector",this.config.selector),t.setAttribute("data-abra-block",this.config.type),t.classList.add("abra-hide")}),this.applied=!0,!0}undo(){return this.#e.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),this.elements?.forEach(t=>{t.removeAttribute("data-abra-selector"),t.removeAttribute("data-abra-block"),t.classList.remove("abra-hide")}),this.applied=!1,!0}#i(){return this.elements=document.querySelectorAll(this.config.selector),this}}class MoneyBlock{static #t=this.validate=t=>{let e=[];return(t.container||e.push("'container' is required"),t.selector||e.push("'selector' is required"),e.length>0)?{errors:e,config:t}:{errors:!1,config:t}};#e;constructor(t,i){this.#e=logger.createSubLogger(`blocks/money/${t}`),this.applied=!1,this.config=i,this.id=t,this.morphels=[],this.promotion=null,this.type=i.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}async apply(t){return void 0===t&&(t={}),this.#e.debug("applying",{id:this.id,config:this.config}),this.#i(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.applied=await this.#o(),this.applied}undo(){for(let t of(this.#e.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),this.morphels))t.restore();return this.applied=!1,this.morphels=[],!0}#r(){return this.morphels=[],document.querySelectorAll(this.config.selector).forEach(e=>{this.morphels.push(new Morphel(e))}),this}async #o(){for(let t of(this.#r(),this.morphels)){let e=t.el.getAttribute("data-abra-block");if("cart"===e||"cart-item"===e||"product"===e){this.#e.debug(`skipping element, ${e} takes precedence`);continue}let n=t.el.getAttribute("data-product-handle")?t.el.getAttribute("data-product-handle"):findProductHandle(t.el,this.config.container);if(!n){this.#e.debug("skipping element, product handle not found",{element:t.el});continue}let l=null,c=null;try{let e=await fetchProductByHandle(n,{logger:this.#e});e&&(l=new Product(e),c=this.#n(t,l))}catch(t){this.#e.error("product failed to fetch",{error:t})}if(!l){this.#e.debug("skipping element, product not found",{element:t.el});continue}if(!c){this.#e.debug("skipping element, variant not found",{element:t.el});continue}if(this.promotion&&this.promotion.isShownInProduct(this.type,n,c)&&this.promotion.isProductEntitled(n,c)){if(this.config.html){let e=t.el;this.config.price&&(e=t.el.querySelector(this.config.price)??t.el);let i=this.#s(e,c),r=i?await this.promotion?.applyToPrice(new Price(i),n,c):void 0;if(!r){this.#e.debug("skipping element, final price coudn't be calculated",{element:t.el,money:i});continue}let l=r.toJSON(),p=compile(this.config.html,{code:this.promotion.displayCode,currency:{iso_code:window.Abra.currency},final_price:money_formatMoney(l.final),original_price:money_formatMoney(l.original),redeemCode:this.promotion.redeemCode??"",total_discount:money_formatMoney(l.originalTotalDiscount),total_discount_dollar:money_formatMoney(l.originalTotalDiscount),total_discount_percentage:String(Math.round(l.originalTotalDiscount/l.original*100))+"%"});t.morph(p,defaultMorphOptions),t.el.setAttribute("data-abra-selector",this.config.selector),t.el.setAttribute("data-abra-block",this.config.type),i&&e.setAttribute("data-abra-money",`${c}:${i}`),this.config.price&&t.el.setAttribute("data-abra-price-selector",this.config.price)}t.el.setAttribute("data-product-handle",n)}}return!0}#n(t,e){let i=t.el.getAttribute("data-variant-id"),o=findVariantId(),r=e.variants.length?e.variants[0].id:null;return i||o||r}#s(t,e){let i=t.getAttribute("data-abra-money");if(i){let[t,o]=i.split(":");if(t==e&&o)return this.#e.debug("using data-abra-money value",{attribute:i}),parseInt(o,10)}return this.#e.debug("using text content value",{textContent:t.textContent}),t.textContent?function(e){let r=function(e){let r=/\d(\.|\d|,)*/gm.exec(e);return r?r[0]:void 0}(e);return r?function(e){if("number"==typeof e)return e;let{thousandsMark:r,decimalMark:o}=function(e){switch(e){case"ANG":case"ARS":case"BRL":case"CLF":case"CLP":case"COP":case"CRC":case"DKK":case"EUR":case"HRK":case"IDR":case"ISK":case"MZN":case"NOK":case"RON":case"RUB":case"TRY":case"UYU":case"VES":case"VND":return{thousandsMark:".",decimalMark:","};default:return{thousandsMark:",",decimalMark:"."}}}(getShopCurrency()),u=e.replaceAll(r,"").split(o);if(!u[0]||!u[1]){n.debug("money couldn't be parsed",{amount:e,thousandsMark:r,decimalMark:o,parts:u});return}let c=u[0],a=u[1].length;return parseInt(c,10)*Math.pow(10,a)+parseInt(u[1],10)}(r):void 0}(t.textContent):void 0}#i(t){this.promotion=t.promotion??getActivePromotion()}}class PopupBlock{static #i=this.validate=i=>({errors:!1,config:i});#t;constructor(t,o){this.#t=logger.createSubLogger("blocks/popup"),this.applied=!1,this.config=o,this.id=t,this.promotion=null,this.type=o.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}apply(i){if(void 0===i&&(i={}),this.#t.debug("applying",{id:this.id,config:this.config}),this.#o(i),this.config.onevent&&addListener(this.config.onevent,this.apply),this.config.persistentState){let i=this.config.states?.at(0);i&&(i.text=compile(i.text,generateDefaultBlockProps({promotion:this.promotion})),window.Abra.Popup.show(i))}return this.applied=!0,!0}undo(){return this.#t.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),window.Abra.Popup.hide(),this.applied=!1,!0}#o(i){this.promotion=i.promotion??getActivePromotion()}}class ProductBlock{static #t=this.validate=t=>{let e=[];return(t.selector||e.push("'selector' is required"),e.length>0)?{errors:e,config:t}:{errors:!1,config:t}};#e;constructor(t,i){this.#e=logger.createSubLogger(`blocks/product/${t}`),this.applied=!1,this.config=i,this.id=t,this.morphels=[],this.promotion=null,this.type=i.type,this.priceMode=includesVars(i.html,"compare_at_price","selected_variant.compare_at_price")?"compare_at":"original",this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}async apply(t){return void 0===t&&(t={}),this.#e.debug("applying",{id:this.id,config:this.config}),this.#i(t),this.config.onevent&&addListener(this.config.onevent,this.apply),this.applied=await this.#o(),this.applied}undo(){for(let t of(this.#e.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),this.morphels))t.restore();return this.applied=!1,this.morphels=[],!0}#r(){return this.morphels=[],document.querySelectorAll(this.config.selector).forEach(e=>{this.morphels.push(new Morphel(e))}),this}async #o(){for(let t of(this.#r(),this.morphels)){let e=t.el.getAttribute("data-abra-block");if("cart"===e||"cart-item"===e){this.#e.debug(`skipping element, ${e} takes precedence`);continue}let r=t.el.getAttribute("data-product-handle")?t.el.getAttribute("data-product-handle"):findProductHandle(t.el,this.config.container);if(!r){this.#e.debug("skipping element, product handle not found",{element:t.el});continue}let l=t.el.getAttribute("data-variant-id")?t.el.getAttribute("data-variant-id"):findVariantId(t.el),c=null;try{let t=await fetchProductByHandle(r,{logger:this.#e});t&&(c=new Product(t))}catch(t){this.#e.error("product failed to fetch",{error:t})}if(!c){this.#e.debug("skipping element, product can't be found",{element:t.el});continue}let p=c.getFirstOrSelectedVariant(l);if(!this.promotion||!this.promotion.isProductEntitled(c.handle,p.id)){this.#e.debug("skipping element, product isn't entitled",{element:t.el});continue}if(!this.promotion.isShownInProduct(this.type,c.handle,p.id)){this.#e.debug("skipping element, promotion isn't shown on product page",{element:t.el});continue}if(await this.promotion.applyToProduct(c,p.id),!c.discounted){this.#e.debug("skipping element, product isn't discounted");continue}let a=c.getPrice()?.toJSON(),g=c.getUnitPrice()?.toJSON(),m=c.getUnitPriceMeasurement(),f=p.price?.toJSON(),b=p.unitPrice?.toJSON();if(a&&f&&this.config.html){let e=compile(this.config.html,function(e){let{promotion:o,finalPrice:i,productPrice:r,productUnitPrice:n,variantPrice:a,variantUnitPrice:c,selectedVariant:l,product:u,productUnitPriceMeasurement:s,priceMode:p}=e;return{code:o.displayCode,compare_at_price:money_formatMoney(r.compareAt),compare_at_total_discount:money_formatMoney(r.compareAtTotalDiscount),currency:{iso_code:window.Abra.currency},final_price:i,final_unit_price:money_formatMoney(n?.final),original_price:money_formatMoney(r.original),original_total_discount:money_formatMoney(r.originalTotalDiscount),original_unit_price:money_formatMoney(n?.original),redeemCode:o.redeemCode??"",selected_variant:{compare_at_price:money_formatMoney(a.compareAt),compare_at_total_discount:money_formatMoney(a.compareAtTotalDiscount),final_price:money_formatMoney(a.final),final_unit_price:money_formatMoney(c?.final),original_total_discount:money_formatMoney(a.originalTotalDiscount),original_price:money_formatMoney(a.original),original_unit_price:money_formatMoney(c?.original),unit_price_measurement:{reference_unit:l.unitPriceMeasurement?.referenceUnit||""},total_discount:"compare_at"===p?money_formatMoney(a.compareAtTotalDiscount):money_formatMoney(a.originalTotalDiscount),total_discount_dollar:"compare_at"===p?money_formatMoney(a.compareAtTotalDiscount):money_formatMoney(a.originalTotalDiscount),total_discount_percentage:String(Math.round("compare_at"===p?a.compareAtTotalDiscount/a.compareAt*100:a.originalTotalDiscount/a.original*100))+"%"},title:u.title,total_discount:"compare_at"===p?money_formatMoney(r.compareAtTotalDiscount):money_formatMoney(r.originalTotalDiscount),total_discount_dollar:"compare_at"===p?money_formatMoney(r.compareAtTotalDiscount):money_formatMoney(r.originalTotalDiscount),total_discount_percentage:String(Math.round("compare_at"===p?r.compareAtTotalDiscount/r.compareAt*100:r.originalTotalDiscount/r.original*100)+"%"),unit_price_measurement:{reference_unit:s?.referenceUnit||""},url:u.url}}({finalPrice:this.#n(c,a),priceMode:this.priceMode,product:c,productPrice:a,productUnitPrice:g,productUnitPriceMeasurement:m,promotion:this.promotion,selectedVariant:p,variantPrice:f,variantUnitPrice:b}));t.morph(e,defaultMorphOptions),t.el.setAttribute("data-abra-selector",this.config.selector),t.el.setAttribute("data-abra-block",this.config.type)}t.el.setAttribute("data-product-handle",r)}return!0}#n(t,e){let i="";return e.final&&(i=money_formatMoney(e.final),t.doesPriceVary()&&window.Abra.settings?.translations?.final_price_varies&&(i=compile(window.Abra.settings.translations.final_price_varies,{price:i}))),i}#i(t){this.promotion=t.promotion??getActivePromotion()}}class RemoveClassBlock{static #t=this.validate=t=>{let e=[];return(t.selector||e.push("'selector' is required"),t.value||e.push("'value' is required"),e.length>0)?{errors:e,config:t}:{errors:!1,config:t}};#e;constructor(e,i){this.#e=logger.createSubLogger("blocks/add-class"),this.applied=!1,this.config=i,this.elements=[],this.id=e,this.type=i.type,this.apply=this.apply.bind(this),this.undo=this.undo.bind(this)}apply(){for(let t of(this.#e.debug("applying",{id:this.id,config:this.config}),this.config.onevent&&addListener(this.config.onevent,this.apply),this.#i(),this.elements))t.setAttribute("data-abra-selector",this.config.selector),t.setAttribute("data-abra-block",this.config.type),t.classList.remove(this.config.value);return this.applied=!0,!0}undo(){for(let t of(this.#e.debug("undoing",{config:this.config}),this.config.onevent&&removeListener(this.config.onevent,this.apply),this.elements))t.removeAttribute("data-abra-selector"),t.removeAttribute("data-abra-block"),t.classList.add(this.config.value);return this.elements=[],this.applied=!1,!0}#i(){return this.elements=Array.from(document.querySelectorAll(this.config.selector)),this}}let Registry={"add-class":AddClassBlock,"announcement-bar":AnnouncementBarBlock,banner:BannerBlock,"banner-gift":BannerBlock,cart:CartBlock,"cart-item":CartItemBlock,"dynamic-text":DynamicTextBlock,hide:HideBlock,money:MoneyBlock,popup:PopupBlock,product:ProductBlock,"remove-class":RemoveClassBlock},engine_a=[];class Engine{#s;constructor(){this.#s=logger.createSubLogger("engine"),this.schema=null}initialize(s){return this.schema=s,this}async run(){if(!this.schema)return this.#s.warn("you must set a schema before running a promotion"),!1;this.#s.debug(`running blocks for "${this.schema.page?.fullName}"`,{blocks:this.schema.blocks});let s=getActivePromotion(),o=await getCart(),i=Object.keys(this.schema.blocks).map(async e=>{if(!this.schema)return!1;let r=this.schema.blocks[e],i=Registry[r.type];if(i){let{errors:t}=i.validate(r);if(t)return this.#s.error(`'${e}' is invalid`,{errors:t}),!1;let n=new i(e,r,this.schema),c=await n.apply({cart:o,promotion:s});return engine_a.push(n),c}return!1});return await Promise.all(i),!0}async rerun(){let s=getActivePromotion(),t=await getCart(),o=engine_a.map(e=>e.apply({cart:t,promotion:s}));return await Promise.all(o),!0}async renderBlock(s){if(!this.schema)return this.#s.warn("you must set a schema before running a promotion"),!1;this.#s.debug(`running block ${s} for "${this.schema.page?.fullName}"`,{blocks:this.schema.blocks});let t=this.schema.blocks[s];if(!t)return this.#s.warn(`schema does not contain a block with id ${s}`),!1;let o=engine_a.find(t=>t.id===s);if(!o)return this.#s.warn("block not found, you must activate the promotion first"),!1;let i=getActivePromotion(),n=await getCart(),c=await o.apply({cart:n,promotion:i});return c}async unload(){let s=engine_a.map(s=>s.undo());await Promise.all(s),this.clear()}clear(){engine_a=[],this.schema=null}}async function createAbraEvent(t,e,a){let{logger:r}=void 0===a?{}:a;try{let a=await fetch("/apps/abra/events?_abraignore=1",{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({name:t,metadata:e?JSON.stringify(e):null})});return a.ok||r?.error(`abra event failed to create: status=${a.status}`),a}catch(t){throw r?.alert("abra event failed to create",t),t}}async function fetchDiscount(n){try{n=decodeURIComponent(n)}catch(n){}n=encodeURIComponent(n);let t=await fetch(`/discount/${n}`,{credentials:"include"});return t.ok}async function fetchPromotion(t,o){let n,{logger:i}=void 0===o?{}:o;try{n=await fetchCart({logger:i})}catch(e){i?.error(e)}try{t=decodeURIComponent(t)}catch(e){}t=encodeURIComponent(t);try{let e=await fetch("/apps/abra/promotion?_abraignore=1",{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({code:t,cart:n?{token:n.token}:null,theme:window.Shopify?.theme?{id:window.Shopify.theme.id,name:window.Shopify.theme.name,themeStoreId:window.Shopify.theme.theme_store_id}:null})});return 404===e.status&&(e=await fetch("/apps/magiclinkapp/promotion?_abraignore=1",{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({code:t,theme:window.Shopify?.theme?{id:window.Shopify.theme.id,name:window.Shopify.theme.name,themeStoreId:window.Shopify.theme.theme_store_id}:null})})),e.ok||i?.error(`promotion failed to fetch: status=${e.status}`),e}catch(e){throw i?.alert("promotion failed to fetch",e),e}}class Poller{#t;#i;constructor(t,i={}){this.cb=t,this.intervalMs=i.intervalMs||500,this.maxTries=i.intervalMs||20,this.#i=0}isPolling(){return void 0!==this.#t}start(){this.isPolling()&&this.stop(),this.#t=setInterval(()=>{if(this.#i>=this.maxTries){this.stop();return}this.cb()},this.intervalMs)}stop(){this.#t&&(clearInterval(this.#t),this.#t=void 0,this.#i=0)}}class Integration{#i;constructor(t,e="",r="",n=!0){this.#i=logger.createSubLogger(`integrations/${t}`),this.autolink=n,this.id=t,this.linked=!1,this.name=e,this.url=r}link(){this.#i.error(`${this.name} integration not implemented`)}setLinked(i){this.linked=!!i,this.linked&&(this.#i.info(`${this.name} integration linked`,{id:this.id,name:this.name,url:this.url}),createAbraEvent("INTEGRATION_LINKED",{id:this.id,name:this.name,url:this.url}))}}class AftersellUpCartIntegration extends Integration{#t;constructor(){super("aftersell-upcart","UpCart","https://apps.shopify.com/upcart-cart-builder"),this.onAbraCartChanged=this.onAbraCartChanged.bind(this),this.#t=new Poller(()=>{void 0!==window.upcartRegisterAddToCart&&(this.#t.stop(),window.addEventListener("abra:cart:changed",this.onAbraCartChanged),this.setLinked(!0))},{maxTries:20,intervalMs:500})}link(){this.#t.start()}onAbraCartChanged(){"function"==typeof window.upcartRegisterAddToCart&&window.upcartRegisterAddToCart()}}class SlideCartIntegration extends Integration{#n;constructor(){super("slide-cart","Slide Cart","https://apps.shopify.com/slide-cart"),this.onAbraCartChanged=this.onAbraCartChanged.bind(this),this.#n=new Poller(()=>{if(void 0===window.SLIDECART)return;let n=[this.#t(),this.#e(),this.#i(),this.#o()];n.every(n=>!0===n)&&(this.#n.stop(),this.setLinked(!0))},{maxTries:20,intervalMs:500})}link(){this.#n.start()}onAbraCartChanged(){"function"==typeof window.SLIDECART_UPDATE&&window.SLIDECART_UPDATE()}#t(){if(void 0===window.SLIDECART)return!1;let n=window.SLIDECART_UPDATED;return window.SLIDECART_UPDATED=function(t){"function"==typeof n&&n(t),window.dispatchEvent(new CustomEvent("abra:render"))},!0}#e(){if(void 0===window.SLIDECART)return!1;let n=window.SLIDECART_LOADED;return window.SLIDECART_LOADED=function(t){"function"==typeof n&&n(t),window.dispatchEvent(new CustomEvent("abra:render"))},!0}#i(){if(void 0===window.SLIDECART)return!1;let n=window.SLIDECART_OPENED;return window.SLIDECART_OPENED=function(){"function"==typeof n&&n(),window.dispatchEvent(new CustomEvent("abra:render"))},!0}#o(){return void 0!==window.SLIDECART&&(window.addEventListener("abra:cart:changed",this.onAbraCartChanged),!0)}}class Page{constructor(t){this.name=t.name,this.suffix=t.suffix,this.promotion=null}get fullName(){return(this?.suffix?`${this?.name}.${this?.suffix}`:this?.name)||null}isEligible(t){return!0}areSomeProductsInPageEligible(){if(!this.promotion)return!1;let i=findAllProductsInDOM();return i.some(t=>this.promotion?.isProductEntitled(t,null))}findAllProductsInDOM(){return findAllProductsInDOM()}}class ProductPage extends Page{isEligible(){let o=findProductHandle();return!!o&&!!this.promotion?.isProductEntitled(o,null)}}class ProductCache{constructor(){this.data=new Map}init(t){this.data=new Map(Object.entries(t))}has(t){return this.data.has(t)}get(t){return this.data.get(t)}set(t,e){return this.data.set(t,e)}delete(t){return this.data.delete(t)}clear(){this.data=new Map}}class Schema{#s;constructor(s,t){this.blocks={},this.config=s,this.#s=t,this.setBlocks()}get page(){return this.#s}set page(s){this.#s=s,this.setBlocks()}setBlocks(){let s=this.config.all||{},t=this.page?.name&&this.config[this.page.name],e=this.page?.fullName&&this.config[this.page.fullName];this.blocks={...s,...t||{},...e||{}}}}class AnnouncementBar{#e;constructor(){this.#e=logger.createSubLogger("announcement-bar")}hide(){window.dispatchEvent(new CustomEvent("abra:announcement-bar:hide"))}render(e){void 0===e&&(e={}),window.dispatchEvent(new CustomEvent("abra:announcement-bar:render",{detail:e}))}show(e){void 0===e&&(e={}),window.dispatchEvent(new CustomEvent("abra:announcement-bar:show",{detail:e}))}addListener(e,n){switch(e){case"hidden":case"shown":return window.addEventListener(`abra:announcement-bar:${e}`,n),()=>window.removeEventListener(`abra:announcement-bar:${e}`,n);default:return this.#e.error(`${e} is invalid, use 'hidden' or 'shown'`),()=>{}}}removeListener(e,n){switch(e){case"hidden":case"shown":window.removeEventListener(`abra:announcement-bar:${e}`,n);break;default:this.#e.error(`${e} is invalid, use 'hidden' or 'shown'`)}}}class Banner{#e;constructor(){this.#e=logger.createSubLogger("banner")}show(e,n){void 0===e&&(e="default"),void 0===n&&(n={}),window.dispatchEvent(new CustomEvent(`abra:banner:${e}:show`,{detail:n}))}hide(e){void 0===e&&(e="default"),window.dispatchEvent(new CustomEvent(`abra:banner:${e}:hide`))}addListener(e,n,r){switch(void 0===e&&(e="default"),n){case"hidden":case"shown":return window.addEventListener(`abra:banner:${e}:${n}`,r),()=>window.removeEventListener(`abra:banner:${e}:${n}`,r);default:return this.#e.error(`${n} is invalid, use 'hidden' or 'shown'`),()=>{}}}removeListener(e,n,r){switch(void 0===e&&(e="default"),n){case"hidden":case"shown":window.removeEventListener(`abra:banner:${e}:${n}`,r);break;default:this.#e.error(`${n} is invalid, use 'hidden' or 'shown'`)}}}class DynamicText{#e;constructor(){this.#e=logger.createSubLogger("dynamic-text")}show(e,i){void 0===e&&(e="default"),void 0===i&&(i={}),window.dispatchEvent(new CustomEvent(`abra:dynamic-text:${e}:show`,{detail:i}))}hide(e){void 0===e&&(e="default"),window.dispatchEvent(new CustomEvent(`abra:dynamic-text:${e}:hide`))}addListener(e,i,t){switch(void 0===e&&(e="default"),i){case"hidden":case"shown":return window.addEventListener(`abra:dynamic-text:${e}:${i}`,t),()=>window.removeEventListener(`abra:dynamic-text:${e}:${i}`,t);default:return this.#e.error(`${i} is invalid, use 'hidden' or 'shown'`),()=>{}}}removeListener(e,i,t){switch(void 0===e&&(e="default"),i){case"hidden":case"shown":window.removeEventListener(`abra:dynamic-text:${e}:${i}`,t);break;default:this.#e.error(`${i} is invalid, use 'hidden' or 'shown'`)}}}class Integrations{#i;constructor(t){this.#i=logger.createSubLogger("integrations"),this.all=t||[]}add(i){if(this.find(i.id)){this.#i.warn(`${i.name} already exists`);return}this.all.push(i)}find(i){return this.all.filter(t=>t.id===i)[0]}isLinked(i){let t=this.find(i);return!!t&&t.linked}link(){this.#i.info("linking app integrations"),this.all.forEach(i=>{i.autolink&&!i.linked&&i.link()})}}class Notification{#i;constructor(){this.#i=logger.createSubLogger("notification")}show(i){void 0===i&&(i={}),window.dispatchEvent(new CustomEvent("abra:notification:show",{detail:i}))}hide(){window.dispatchEvent(new CustomEvent("abra:notification:hide"))}addListener(i,e){switch(i){case"hidden":case"shown":return window.addEventListener(`abra:notification:${i}`,e),()=>window.removeEventListener(`abra:notification:${i}`,e);default:return this.#i.error(`${i} is invalid, use 'hidden' or 'shown'`),()=>{}}}removeListener(i,e){switch(i){case"hidden":case"shown":window.removeEventListener(`abra:notification:${i}`,e);break;default:this.#i.error(`${i} is invalid, use 'hidden' or 'shown'`)}}}class Popup{#e;constructor(){this.#e=logger.createSubLogger("popup")}show(e){void 0===e&&(e={}),window.dispatchEvent(new CustomEvent("abra:popup:show",{detail:e}))}hide(){window.dispatchEvent(new CustomEvent("abra:popup:hide"))}addListener(e,o){switch(e){case"hidden":case"shown":return window.addEventListener(`abra:popup:${e}`,o),()=>window.removeEventListener(`abra:popup:${e}`,o);default:return this.#e.error(`${e} is invalid, use 'hidden' or 'shown'`),()=>{}}}removeListener(e,o){switch(e){case"hidden":case"shown":window.removeEventListener(`abra:popup:${e}`,o);break;default:this.#e.error(`${e} is invalid, use 'hidden' or 'shown'`)}}}function variant_change_n(n){let t=n.detail.variant;if(t?.id){let n=new URL(window.location.href);n.searchParams.set("modal-variant",t.id),window.history.replaceState({path:n.toString()},"",n.toString())}}class HistoryObserver{#t;#e;#i;constructor(e){this.#t=logger.createSubLogger("history"),this.isUnsupported=void 0===window.history?.replaceState,this.onStateChange=e,this.callback=this.callback.bind(this)}observe(){if(this.isUnsupported){this.#t.warn("History isn't supported by this browser. Features may be affected");return}this.#e=window.history.pushState,this.#i=window.history.replaceState,window.history.pushState=new Proxy(window.history.pushState,{apply:(t,e,i)=>(this.callback(),Reflect.apply(t,e,i))}),window.history.replaceState=new Proxy(window.history.replaceState,{apply:(t,e,i)=>(this.callback(),Reflect.apply(t,e,i))})}disconnect(){this.#e&&(window.history.pushState=this.#e,this.#e=void 0),this.#i&&(window.history.replaceState=this.#i,this.#i=void 0)}callback(){window.requestAnimationFrame(()=>this.onStateChange())}}function deleteParamFromLocation(o,t,e){void 0===t&&(t=window.location),void 0===e&&(e=!0);let n=new URLSearchParams(t.search);if(n.has(o)&&(n.delete(o),e)){let o=n.toString()?`${t.pathname}?${n.toString()}`:t.pathname;window.history.replaceState(null,"",o)}}let T=/[?|&]_abraignore=1/i,x=/\/recommendations\/products|\/search|\/variants|\/cart|[?|&]page=|[?|&]section_id=/i;function renderIcon(e,s,a){let{logger:r}=void 0===a?{}:a;switch(s){case"discount":e.classList.remove("abra-hide"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="abra-icon" role="img"><use xlink:href="#AbraIconDiscount"></use></svg>';break;case"gift":e.classList.remove("abra-hide"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="abra-icon" role="img"><use xlink:href="#AbraIconGift"></use></svg>';break;case"percentage":e.classList.remove("abra-hide"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="abra-icon" role="img"><use xlink:href="#AbraIconPercentage"></use></svg>';break;case"":e.classList.add("abra-hide");break;default:r?.warn("icon not supported",{icon:s})}}class AbraAnnouncementBarElement extends HTMLElement{#e;#n;#t;constructor(){var e;let n;super(),this.#e=logger.createSubLogger("announcement-bar"),this.#n="section",this.onHide=this.onHide.bind(this),this.onRender=this.onRender.bind(this),this.onResize=this.onResize.bind(this),this.onShow=this.onShow.bind(this),this.#t=(e=this.onResize,function(){for(var r=arguments.length,o=Array(r),u=0;u<r;u++)o[u]=arguments[u];let l=this;return clearTimeout(n),n=setTimeout(()=>{e.apply(l,o)},200),null})}connectedCallback(){this.dataset.target&&(this.#n=this.dataset.target),this.onResize(),window.addEventListener("abra:announcement-bar:hide",this.onHide),window.addEventListener("abra:announcement-bar:render",this.onRender),window.addEventListener("abra:announcement-bar:show",this.onShow),window.addEventListener("resize",this.#t)}disconnectedCallback(){document.body.style.setProperty("--abra-announcement-bar-height","0px"),window.removeEventListener("abra:announcement-bar:hide",this.onHide),window.removeEventListener("abra:announcement-bar:render",this.onRender),window.removeEventListener("abra:announcement-bar:show",this.onShow),window.removeEventListener("resize",this.#t)}onHide(){document.body.style.setProperty("--abra-announcement-bar-height","0px"),this.classList.remove("abra-announcement-bar--show"),window.dispatchEvent(new CustomEvent("abra:announcement-bar:hidden"))}onRender(e){"string"==typeof e?.detail?.link&&e.detail.link&&this.#i(e.detail.link),"string"==typeof e?.detail?.text&&e.detail.text&&this.#o(e.detail.text),"string"==typeof e?.detail?.icon&&e.detail.icon&&this.#r(e.detail.icon)}onResize(){if("body"===this.#n){let e=this.classList.contains("abra-announcement-bar--show")?`${this.offsetHeight??0}px`:"0px";this.#e.debug(`setting height to ${e}`),document.body.style.setProperty("--abra-announcement-bar-height",e)}}onShow(e){this.onRender(e),this.classList.add("abra-announcement-bar--show"),this.onResize(),window.dispatchEvent(new CustomEvent("abra:announcement-bar:shown")),createAbraEvent("ANNOUNCEMENT_BAR_SHOWN")}#i(e){let n=this.querySelector(".abra-announcement-bar__link");if(n)n.href=e;else{let n=this.querySelector(".abra-announcement-bar__item");if(n){let t=n.innerHTML;n.innerHTML=`<a class="abra-announcement-bar__link" href="${e}">${t}</a>`}else this.#e.warn("link cannot be rendered")}}#o(e){let n=this.querySelector(".abra-announcement-bar__text");n?n.innerText=e:this.#e.warn("text cannot be rendered")}#r(e){let n=this.querySelector(".abra-announcement-bar__icon");n?renderIcon(n,e,{logger:this.#e}):this.#e.warn("icon cannot be rendered",{icon:e,element:this})}}class AbraBannerElement extends HTMLElement{#e;constructor(){super(),this.name="default",this.#e=logger.createSubLogger("banner"),this.onHide=this.onHide.bind(this),this.onShow=this.onShow.bind(this)}connectedCallback(){this.dataset.name&&(this.name=this.dataset.name),window.addEventListener(`abra:banner:${this.name}:hide`,this.onHide),window.addEventListener(`abra:banner:${this.name}:show`,this.onShow)}disconnectedCallback(){window.removeEventListener(`abra:banner:${this.name}:hide`,this.onHide),window.removeEventListener(`abra:banner:${this.name}:show`,this.onShow)}onHide(){this.classList.remove("abra-banner--show"),window.dispatchEvent(new CustomEvent(`abra:banner:${this.name}:hidden`))}onShow(e){this.onRender(e),this.classList.add("abra-banner--show"),window.dispatchEvent(new CustomEvent(`abra:banner:${this.name}:shown`)),createAbraEvent("BANNER_SHOWN")}onRender(e){this.#e.debug("rendering banner",{detail:e?.detail}),"string"==typeof e?.detail?.link&&e.detail.link&&this.#n(e.detail.link),"string"==typeof e?.detail?.text&&e.detail.text&&this.#r(e.detail.text),"string"==typeof e?.detail?.icon&&e.detail.icon&&this.#a(e.detail.icon),"object"==typeof e?.detail?.offer&&e.detail.offer&&this.#t(e.detail.offer)}#n(e){let n=this.querySelector(".abra-banner__link");if(n)n.href=e;else{let n=this.innerHTML;this.innerHTML=`<a class="abra-banner__link" href="${e}">${n}</a>`}}#r(e){let n=this.querySelector(".abra-banner__text");n?n.innerHTML=e:this.#e.warn("text cannot be rendered",{element:this})}#a(e){let n=this.querySelector(".abra-banner__icon");n?renderIcon(n,e,{logger:this.#e}):this.#e.warn("icon cannot be rendered",{icon:e,element:this})}#t(n){let{title:r,image:a,price:t,progress:i,productHandle:s,variantId:o}=n,d=this.querySelector(".abra-banner__offer");if(d){let n=`<div class="abra-banner__offer" data-product-handle="${s}" data-variant-id="${o}">
        <div class="abra-banner__offer-content">
          <div class="abra-banner__offer-badges">
            ${this.#i()}
          </div>
          <h2 class="abra-banner__offer-title"></h2>
          <div class="abra-banner__offer-price">
            <span data-price></span>
          </div>
        </div>
        ${this.#s(a)}
      </div>`;if(morphel_esm(d,n),r){let e=d.querySelector(".abra-banner__offer-title");e&&(e.innerHTML=r)}if(t){let e=d.querySelector(".abra-banner__offer-price");if(e){let n=e.querySelector("[data-price]");n&&(n.innerHTML=t,e.append(" value"))}}}else this.#e.warn("offer cannot be rendered",{offer:n,element:this});let l=this.querySelector(".abra-banner__progress-bar");if(l){let n=this.#o(i);morphel_esm(l,n)}else this.#e.warn("progress cannot be rendered",{offer:n,element:this})}#i(){return`<div class="abra-banner__badge">
      <span class="abra-banner__badge-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="abra-icon" role="img">
          <use xlink:href="#AbraIconGift"></use>
        </svg>
      </span>
      <span class="abra-banner__badge-label">Free gift</span>
    </div>`}#s(e){if(!e||!e.src)return"";let n=!!(window.matchMedia&&(window.matchMedia("only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)").matches||window.matchMedia("only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)").matches)||window.devicePixelRatio&&window.devicePixelRatio>1.3),r=new URL(e.src),a=n?240:120,i=n?240:120;return r.searchParams.set("width",a.toString()),r.searchParams.set("height",i.toString()),`<div class="abra-banner__offer-image">
      <img width="${a}" height="${i}" loading="lazy" src="${r.toString()}" />
    </div>`}#o(e){return e?`<div class="abra-banner__progress-bar" style="--abra-banner-progress-bar-progess: ${e}%;">
      <progress value="${e}" max="100"></progress>
    </div>`:""}}class AbraDynamicTextElement extends HTMLElement{#e;constructor(){super(),this.name="default",this.#e=logger.createSubLogger("dynamic-text"),this.onHide=this.onHide.bind(this),this.onShow=this.onShow.bind(this)}connectedCallback(){this.#t(),this.dataset.name&&(this.name=this.dataset.name),window.addEventListener(`abra:dynamic-text:${this.name}:hide`,this.onHide),window.addEventListener(`abra:dynamic-text:${this.name}:show`,this.onShow)}disconnectedCallback(){window.removeEventListener(`abra:dynamic-text:${this.name}:hide`,this.onHide),window.removeEventListener(`abra:dynamic-text:${this.name}:show`,this.onShow)}onHide(){this.classList.remove("abra-dynamic-text--show"),window.dispatchEvent(new CustomEvent(`abra:dynamic-text:${this.name}:hidden`))}onShow(e){this.onRender(e),this.classList.add("abra-dynamic-text--show"),window.dispatchEvent(new CustomEvent(`abra:dynamic-text:${this.name}:shown`)),createAbraEvent("DYNAMIC_TEXT_SHOWN")}onRender(e){"string"==typeof e?.detail?.text&&e.detail.text&&this.#i(e.detail.text),"string"==typeof e?.detail?.icon&&e.detail.icon&&this.#n(e.detail.icon)}#i(e){let t=this.querySelector(".abra-dynamic-text__text");t?t.innerText=e:this.#e.warn("text cannot be rendered",{element:this})}#n(e){let t=this.querySelector(".abra-dynamic-text__icon");t?renderIcon(t,e,{logger:this.#e}):this.#e.warn("icon cannot be rendered",{icon:e,element:this})}#t(){(function(n,e){let s=n instanceof Element?n.closest(`.${e}`):null;return null!==s})(this,"announcement-slider__slide")&&this.closest(".abra-dynamic-text-block")?.classList.add("announcement-slider__content")}}class AbraNotificationElement extends HTMLElement{#t;#i;constructor(){super(),this.#t=logger.createSubLogger("notification"),this.#i=null,this.onShow=this.onShow.bind(this),this.onHide=this.onHide.bind(this)}connectedCallback(){window.addEventListener("abra:notification:show",this.onShow),window.addEventListener("abra:notification:hide",this.onHide),this.querySelector(".abra-notification__close")?.addEventListener("click",this.onHide)}disconnectedCallback(){this.#i&&(clearTimeout(this.#i),this.#i=null),window.removeEventListener("abra:notification:show",this.onShow),window.removeEventListener("abra:notification:hide",this.onHide)}show(t){let{content:e,error:n}=void 0===t?{}:t;if(!e){this.#t.warn("you must provide content");return}this.#o(e),this.classList.add("abra-notification--show"),n&&this.classList.add("abra-notification--error"),window.dispatchEvent(new CustomEvent("abra:notification:shown")),this.#i=setTimeout(this.onHide,7e3),createAbraEvent("NOTIFICATION_SHOWN")}hide(){this.classList.remove("abra-notification--show"),this.classList.remove("abra-notification--error"),this.#i&&(clearTimeout(this.#i),this.#i=null),window.dispatchEvent(new CustomEvent("abra:notification:hidden"))}onShow(t){this.show({content:t?.detail?.content})}onHide(){this.hide()}#o(t){let i=this.querySelector(".abra-notification__content");i&&(i.innerText=t)}}class AbraPopupElement extends HTMLElement{#t;#e;constructor(){super(),this.#t=logger.createSubLogger("popup"),this.#e=null,this.icon="",this.text="",this.onHide=this.onHide.bind(this),this.onShow=this.onShow.bind(this),this.onDismiss=this.onDismiss.bind(this)}connectedCallback(){window.addEventListener("abra:popup:hide",this.onHide),window.addEventListener("abra:popup:show",this.onShow),this.querySelector(".abra-popup__close-button")?.addEventListener("click",this.onDismiss)}disconnectedCallback(){this.#e&&(clearTimeout(this.#e),this.#e=null),window.removeEventListener("abra:popup:hide",this.onHide),window.removeEventListener("abra:popup:show",this.onShow)}onShow(t){let i=!!t?.detail?.text&&"hidden"===window.sessionStorage.getItem(`abra:popup:${encodeURIComponent(t.detail.text)}`);if(i)return;let o=t?.detail?.autohide??this.getAttribute("autohide");this.onRender(t),this.classList.add("abra-popup--show"),o&&(this.#e=setTimeout(this.onHide,parseInt(o.toString(),10)||0)),window.dispatchEvent(new CustomEvent("abra:popup:shown")),createAbraEvent("POPUP_SHOWN")}onHide(){this.classList.remove("abra-popup--show"),this.#e&&(clearTimeout(this.#e),this.#e=null),window.dispatchEvent(new CustomEvent("abra:popup:hidden")),window.sessionStorage.setItem(`abra:popup:${encodeURIComponent(this.text)}`,"hidden")}onDismiss(){this.onHide(),createAbraEvent("POPUP_DISMISSED")}onRender(t){"string"==typeof t?.detail?.text&&t.detail.text&&(this.text=t.detail.text,this.#i(t.detail.text)),"string"==typeof t?.detail?.icon&&t.detail.icon&&(this.icon=t.detail.icon,this.#o(t.detail.icon))}#i(t){let e=this.querySelector(".abra-popup__text");e?e.innerText=t:this.#t.warn("text cannot be rendered",{element:this})}#o(t){let e=this.querySelector(".abra-popup__icon");e?renderIcon(e,t,{logger:this.#t}):this.#t.warn("icon cannot be rendered",{icon:t,element:this})}}window.customElements.define("abra-announcement-bar",AbraAnnouncementBarElement),window.customElements.define("abra-banner",AbraBannerElement),window.customElements.define("abra-dynamic-text",AbraDynamicTextElement),window.customElements.define("abra-notification",AbraNotificationElement),window.customElements.define("abra-popup",AbraPopupElement),window.Abra=new class{#e;#t;#i;#n;#o;constructor(){this.#t=logger,this.AnnouncementBar=new AnnouncementBar,this.Banner=new Banner,this.DynamicText=new DynamicText,this.Integrations=new Integrations([new AftersellUpCartIntegration,new SlideCartIntegration]),this.Notification=new Notification,this.Popup=new Popup,this.#e=new Engine,this.#i=new dist({concurrency:1}),this.cache={products:new ProductCache},this.currency="USD",this.designMode=!1,this.previewMode=function(){let r=function(e){void 0===e&&(e=window.location);let t=new URLSearchParams(e.search);return t.get("preview_theme_id")}();r&&window.localStorage.setItem("abra:preview-mode",getXMinutesFromNow(60).toString());let i=!1,n=window.localStorage.getItem("abra:preview-mode");return n&&(i=parseInt(n,10)>=Date.now()),"1"===api.get("preview_theme")||i}(),this.initialized=!1,this.moneyFormat="${{amount}}",this.moneyWithCurrencyFormat="${{amount}} {{currency}}",this.settings=window.Abra?.settings||window.AbraSettings||{},this.template=null,this.version="9.30.3",this.renderListener=this.renderListener.bind(this)}async initialize(){this.initialized=!0,window.dispatchEvent(new CustomEvent("abra:initialized")),document.body.classList.add("abra--initialized"),this.designMode&&document.body.classList.add("abra--activated");let e=function(o){void 0===o&&(o=window.location);let t=new URLSearchParams(o.search);return!!t.get("abraclear")}();e&&clearActivePromotion();let t=function(o){void 0===o&&(o=window.location);let t=new URLSearchParams(o.search);return t.get("abralink")}(),i=function(o){void 0===o&&(o=window.location);let t=new URLSearchParams(o.search);return t.get("magiclinks")}(),n=function(o){void 0===o&&(o=window.location);let t=new URLSearchParams(o.search);return t.get("code")||t.get("discount")}(),o=getActivePromotion(),r=function(o){let{logger:t}=void 0===o?{}:o,e=document.getElementById("AbraPublicPromotion");if(e&&e.textContent)try{return JSON.parse(e.textContent)}catch(o){t?.alert("public promotion failed to parse",o)}return null}();return t?await this.activate(t,n,void 0):i?await this.activate(i,n,void 0):o&&o.code&&!this.designMode&&o.code!==r?.code?await this.activate(o.code,o.redeemCode,void 0):r&&r.code&&await this.activate(r.code,n,{promotion:r}),this.clearLocation(),this.#t.debug("initialized"),this}async activate(e,t,i){try{e=decodeURIComponent(e)}catch(e){}e=encodeURIComponent(e);let n=getActivePromotion();return i?.passive&&n&&(n.redeemCode??void 0)===(t??void 0)?(this.#t.debug("promotion already active, skipping due to passive option"),!0):(t&&this.#t.debug(`using redeem code ${t}`),!!await this.announce(e,t,i)&&(await this.apply(e,t),await attributeCartToCode(e,t),createAbraEvent("PROMOTION_ACTIVATED"),window.Shopify.theme?.theme_store_id,window.addEventListener("variant:change",variant_change_n),document.addEventListener("variant:change",variant_change_n),document.body.classList.add("abra--activated"),document.body.classList.add(`abra--${e}-activated`),window.dispatchEvent(new CustomEvent("abra:activated",{detail:{code:e}})),!0))}async announce(i,n,o){try{i=decodeURIComponent(i)}catch(e){}i=encodeURIComponent(i),this.#t.debug(`promotion ${i} announcing`);let s=getActivePromotion();s&&i!==s?.code&&n!==s?.redeemCode&&(this.#t.debug(`deactivating previous promotion ${s?.code}`),clearActivePromotion());let a=null;if(o?.promotion&&"object"==typeof o.promotion&&Object.keys(o.promotion).length>1)a=o.promotion;else{let e=await fetchPromotion(i,{logger:this.#t});e.ok&&(a=await e.json())}if(a&&(a.redeemCode=n),!a)return this.#t.debug(`promotion ${i} not found`),!1;if("RESTRICTED"===a.status&&!this.previewMode)return this.#t.error(`promotion ${i} is restricted and can only be viewed in preview mode`),!1;if("DRAFT"===a.status&&!this.previewMode)return this.#t.error(`promotion ${i} is a draft and can only be viewed in preview mode`),!1;let d=new Date;if(a.startsAt&&function(dirtyDate,dirtyDateToCompare){requiredArgs(2,arguments);var date=toDate(dirtyDate),dateToCompare=toDate(dirtyDateToCompare);return date.getTime()<dateToCompare.getTime()}(d,new Date(a.startsAt)))return this.#t.debug(`promotion ${i} is not active yet`,{startsAt:a.startsAt,now:d.toISOString()}),!1;if(a.endsAt&&function(dirtyDate,dirtyDateToCompare){requiredArgs(2,arguments);var date=toDate(dirtyDate),dateToCompare=toDate(dirtyDateToCompare);return date.getTime()>dateToCompare.getTime()}(d,new Date(a.endsAt)))return this.#t.debug(`promotion ${i} has expired`,{endsAt:a.endsAt,now:d.toISOString()}),!1;if(setActivePromotion(a),a.schema){var t;let e=new Schema(a.schema,this.template&&("product"===(t=this.template).name?new ProductPage(t):new Page(t)));this.#e.initialize(e),this.#i.add(()=>this.#e.run()),this.Integrations.link()}return this.#t.debug(`promotion ${i} is active`),this.#o=new NetworkObserver(async()=>{await this.#i.add(()=>this.#e.rerun());let e=getActivePromotion(),t=e?.redeemCode||e?.code;t&&setDiscountInCartForm(t)},{ignoreRegex:T,includeRegex:x}),this.#o.observe(),this.#n=new HistoryObserver(()=>this.#i.add(()=>this.#e.rerun())),this.#n.observe(),window.addEventListener("abra:render",this.renderListener),document.body.classList.add("abra--announced"),document.body.classList.add(`abra--${i}-announced`),window.dispatchEvent(new CustomEvent("abra:announced",{detail:{code:i}})),!0}async apply(e,t){try{e=decodeURIComponent(e)}catch(e){}e=encodeURIComponent(e),this.#t.debug(`promotion ${t||e} applying`),setDiscountInCartForm(t||e);let i=await fetchDiscount(t||e);return i?(document.body.classList.add("abra--applied"),document.body.classList.add(`abra--${e}-applied`),window.dispatchEvent(new CustomEvent("abra:applied",{detail:{code:e}})),this.#t.debug(`promotion ${e} is applied`),!0):(this.#t.debug(`promotion ${e} isn't applied`),!1)}async deactivate(){return!!await this.unapply()&&(window.Shopify.theme?.theme_store_id,window.removeEventListener("variant:change",variant_change_n),document.removeEventListener("variant:change",variant_change_n),this.unannounce())}async unannounce(){let e=getActivePromotion();return e?(this.#t.debug(`promotion ${e} removing announcements`),clearActivePromotion(),this.#o&&this.#o.disconnect(),this.#n&&this.#n.disconnect(),window.removeEventListener("abra:render",this.renderListener),window.location.reload(),!0):(this.#t.error("you must activate a promotion first"),!1)}async unapply(){let e=getActivePromotion();if(!e)return this.#t.error("you must activate a promotion first"),!1;let{code:t}=e;try{t=decodeURIComponent(t)}catch(e){}return t=encodeURIComponent(t),api.remove("discount_code"),document.body.classList.remove("abra--applied"),document.body.classList.remove(`abra--${t}-applied`),window.dispatchEvent(new CustomEvent("abra:unapplied",{detail:{code:t}})),this.#t.debug(`promotion ${t} is unapplied`),!0}async render(e){return e?this.#e.renderBlock(e):this.#i.add(()=>this.#e.rerun())}clearLocation(e){void 0===e&&(e=window.location),deleteParamFromLocation("abralink",e),deleteParamFromLocation("discount",e),deleteParamFromLocation("abraclear",e),deleteParamFromLocation("magiclinks",e),deleteParamFromLocation("code",e)}cacheProduct(e,t){let i={handle:t.handle,id:t.id,featuredImage:t.featured_image?t.featured_image.startsWith("https")?t.featured_image:`https:${t.featured_image}`:null,title:t.title,variants:Object.values(t.variants??[]).map(i=>(function(i,n){let r=n.id.toString(),u=parseDecimalMoney(n.price);return{compareAtPrice:n.compare_at_price?parseDecimalMoney(n.compare_at_price):u,handle:i,id:r,name:n.name,price:u,sellingPlans:Object.values(n.selling_plan_allocations??[]).map(e=>({compareAtPrice:e.compare_at_price?parseDecimalMoney(e.compare_at_price):parseDecimalMoney(e.price),handle:i,id:e.selling_plan_id.toString(),price:parseDecimalMoney(e.price),variantId:r})),unitPrice:n.unit_price?parseDecimalMoney(n.unit_price):void 0,unitPriceMeasurement:n.unit_price_measurement?{quantityValue:n.unit_price_measurement.quantity_value?parseFloat(n.unit_price_measurement.quantity_value):void 0,referenceUnit:n.unit_price_measurement.reference_unit,referenceValue:n.unit_price_measurement.reference_value}:void 0}})(t.handle,i))};return this.cache.products.set(e,i),i}addListener(e,t){switch(e){case"applied":case"unapplied":case"announced":case"unannounced":case"activated":case"deactivated":return window.addEventListener(`abra:${e}`,t),()=>window.removeEventListener(`abra:${e}`,t);default:return this.#t.error(`event "${e}" is invalid`),()=>{}}}removeListener(e,t){switch(e){case"applied":case"unapplied":case"announced":case"unannounced":case"activated":case"deactivated":window.removeEventListener(`abra:${e}`,t);break;default:this.#t.error(`event "${e}" is invalid`)}}async renderListener(e){let t=e.detail?.id;return t?this.#e.renderBlock(t):this.#i.add(()=>this.#e.rerun())}},window.Abra.initialize()})()})();